<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>My Study OS</title>

  <link rel="manifest" href="/My-Study-OS/manifest.json">
  <meta name="theme-color" content="#ffffff">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #02081b;
      --bg-card: #020617;
      --border-subtle: rgba(51,65,85,0.9);
      --accent: #4f46e5;
      --accent-soft: rgba(79,70,229,0.16);
      --accent-strong: #6366f1;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --warning: #facc15;
    }

    .theme-light {
      --bg: #e5e7eb;
      --bg-soft: #f3f4f6;
      --bg-card: #ffffff;
      --border-subtle: rgba(148,163,184,0.8);
      --accent: #2563eb;
      --accent-soft: rgba(37,99,235,0.12);
      --accent-strong: #1d4ed8;
      --text: #111827;
      --text-muted: #6b7280;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #0b1120 0, var(--bg) 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
      transition: background 0.25s ease;
    }

    body.theme-light {
      background: linear-gradient(135deg, #e5e7eb, #ffffff);
    }

    .app {
      width: 100%;
      max-width: 980px;
      background: linear-gradient(135deg, var(--bg-soft), var(--bg-card));
      border-radius: 22px;
      padding: 18px 18px 26px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.5);
      border: 1px solid rgba(148,163,184,0.35);
      position: relative;
      overflow: hidden;
      transition: background 0.25s ease, box-shadow 0.25s ease, border 0.25s ease;
    }

    .theme-light .app {
      box-shadow: 0 14px 30px rgba(148,163,184,0.4);
      border-color: rgba(148,163,184,0.6);
    }

    .logo {
      display: inline-flex;
      align-items: baseline;
      gap: 0.35rem;
      font-weight: 700;
      letter-spacing: 0.08em;
    }

    .logo-main {
      font-size: 1.05rem;
    }

    .logo-pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-strong);
      text-transform: uppercase;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 10px;
    }

    #today-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    #theme-toggle {
      border-radius: 999px;
      padding: 6px 10px;
      background: var(--bg-soft);
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--text-muted);
      font-size: 0.78rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    nav {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .nav-btn {
      border-radius: 999px;
      padding: 7px 12px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-soft);
      color: var(--text-muted);
      font-size: 0.78rem;
      cursor: pointer;
      transition: 0.16s ease;
    }

    .nav-btn.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border-color: var(--accent-strong);
    }

    main {
      margin-top: 4px;
    }

    .section { display: none; }
    .section.active { display: block; }

    .grid-two {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 12px;
    }

    @media (max-width: 780px) {
      .grid-two { grid-template-columns: 1fr; }
      body { padding: 10px; }
      .app {
        padding: 14px 12px 20px;
        border-radius: 18px;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      padding: 12px 12px 14px;
      transition: background 0.2s ease, border 0.2s ease;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 0.96rem;
      font-weight: 600;
    }

    .pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.66);
      color: var(--text-muted);
      white-space: nowrap;
      background: var(--bg-soft);
    }

    .input-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .goal-date-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .goal-date-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 80px;
      font-size: 0.75rem;
    }

    .goal-date-group label {
      color: var(--text-muted);
      font-size: 0.72rem;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 9px;
      border: 1px solid rgba(75,85,99,0.9);
      background: var(--bg-soft);
      color: var(--text);
      font-size: 0.82rem;
    }

    /* ê²€ìƒ‰ ì…ë ¥ì°½ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .search-input {
      width: 100%;
      padding: 6px 8px;
      margin: 4px 0 8px;
      border-radius: 9px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-soft);
      color: var(--text);
      font-size: 0.8rem;
    }
    .search-input::placeholder {
      color: var(--text-muted);
    }

    input:focus,
    select:focus {
      outline: 1px solid var(--accent-strong);
      border-color: var(--accent-strong);
    }

    button {
      border: none;
      cursor: pointer;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 0.78rem;
      font-weight: 500;
      background: var(--accent);
      color: white;
      transition: transform 0.05s ease, box-shadow 0.16s ease,
        background 0.16s ease;
      white-space: nowrap;
      -webkit-appearance: none;
      appearance: none;
      line-height: 1;
    }

    button:hover {
      background: var(--accent-strong);
      box-shadow: 0 6px 14px rgba(79,70,229,0.45);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    button.secondary {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid rgba(75,85,99,0.9);
      box-shadow: none;
    }

    button.secondary:hover { background: var(--bg-soft); }

    button.danger { background: #b91c1c; }
    button.danger:hover {
      background: #dc2626;
      box-shadow: 0 6px 14px rgba(220,38,38,0.45);
    }

    ul { list-style: none; }

    /* HOME - DDAY */
    #dday-main-label {
      font-size: 0.88rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    #dday-main-value {
      font-size: 1.3rem;
      font-weight: 700;
      margin-top: 4px;
    }

    #dday-main-target {
      font-size: 0.88rem;
      margin-top: 2px;
    }

    #dday-list {
      margin-top: 8px;
      max-height: 120px;
      overflow-y: auto;
      font-size: 0.8rem;
      padding-right: 3px;
    }

    .dday-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: 1px solid rgba(31,41,55,0.2);
      gap: 6px;
    }

    .dday-text-main {
      font-weight: 500;
    }

    .dday-text-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* GOALS */
    #goals-list {
      max-height: 130px;
      overflow-y: auto;
      padding-right: 3px;
      margin-top: 4px;
    }

    .goal-item {
      font-size: 0.83rem;
      padding: 4px 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(31,41,55,0.2);
    }

    .goal-text {
      flex: 1;
      margin-right: 4px;
    }

    #home-summary {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
      line-height: 1.5;
    }

    /* TODOS */
    #todo-scope-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .scope-tab {
      font-size: 0.76rem;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: var(--bg-soft);
      color: var(--text-muted);
      cursor: pointer;
    }

    .scope-tab.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border-color: var(--accent-strong);
    }

    #todo-list {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
      border-top: 1px solid rgba(31,41,55,0.2);
    }

    .todo-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 2px;
      border-bottom: 1px solid rgba(31,41,55,0.2);
      gap: 6px;
    }

    .todo-left {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .status-btn {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid rgba(75,85,99,0.9);
      background: var(--bg-soft);
      color: var(--text-muted);
      font-size: 0.82rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .status-btn.success {
      border-color: var(--success);
      color: var(--success);
    }
    .status-btn.partial {
      border-color: var(--warning);
      color: var(--warning);
    }
    .status-btn.fail {
      border-color: var(--danger);
      color: var(--danger);
    }

    .todo-text {
      font-size: 0.87rem;
      word-break: break-word;
    }

    .todo-meta {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .todo-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .tiny {
      font-size: 0.72rem;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      color: var(--text-muted);
      background: transparent;
      white-space: nowrap;
      cursor: pointer;
    }
    
    .todo-legend {
      display: flex;
      gap: 10px;
      font-size: 0.75rem;
      margin: 6px 0 10px;
    }

    .todo-legend .legend {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ìƒ‰ìƒì€ To-do ì•„ì´ì½˜ê³¼ ë™ì¼í•˜ê²Œ */
    .todo-legend .success { color: var(--success); }
    .todo-legend .partial { color: var(--warning); }
    .todo-legend .fail    { color: var(--danger); }
    .todo-legend .none    { color: rgba(148,163,184,0.8); }

    /* POMODORO */
    #pomo-display {
      font-size: 2.1rem;
      font-weight: 700;
      text-align: center;
      margin: 6px 0 4px;
    }

    #pomo-phase {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    #pomo-controls {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    #pomo-progress-text {
      text-align: center;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    #pomo-config-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }

    .config-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.78rem;
    }

    .config-item label { color: var(--text-muted); }

    /* STUDY TIMER */
    #study-time-today {
      font-size: 1.3rem;
      font-weight: 700;
      margin: 4px 0;
    }

    #study-status {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    #study-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    #study-log {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* FOCUS MODE */
    #focus-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.94);
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #focus-overlay-inner {
      max-width: 480px;
      width: 100%;
      background: #020617;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.9);
      padding: 18px 16px 16px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
      color: #f9fafb;
    }

    #focus-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: #f9fafb;
    }

    #focus-subtitle {
      font-size: 0.9rem;
      color: #e5e7eb;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    #focus-timer-label {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: #f9fafb;
    }

    #focus-extra-info {
      font-size: 0.85rem;
      color: #e5e7eb;
      margin-bottom: 6px;
      min-height: 1.2em;
    }

    #focus-hint {
      font-size: 0.76rem;
      color: #9ca3af;
      margin-top: 8px;
    }

    /* CALENDAR */
    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      margin-top: 8px;
      font-size: 0.8rem;
    }

    .calendar-weekday {
      text-align: center;
      padding: 4px 0;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(31,41,55,0.2);
    }

    .calendar-day {
      min-height: 38px;
      border-radius: 8px;
      border: 1px solid rgba(31,41,55,0.3);
      padding: 3px 4px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: var(--bg-soft);
    }

    .calendar-day.other-month { opacity: 0.35; }

    .calendar-day-number { font-size: 0.8rem; }

    .calendar-day-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-strong);
      margin-top: 2px;
      align-self: flex-start;
    }

    .calendar-day.selected {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    #calendar-month-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.88rem;
      margin-bottom: 4px;
    }

    #calendar-month-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    #calendar-month-picker {
      padding: 2px 6px;
      font-size: 0.8rem;
      border-radius: 8px;
      border: 1px solid rgba(75,85,99,0.9);
      background: var(--bg-soft);
      color: var(--text);
    }

    #calendar-selected-date {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    #calendar-task-list {
      margin-top: 6px;
      max-height: 180px;
      overflow-y: auto;
      padding-right: 3px;
      font-size: 0.82rem;
    }

    .calendar-task-item {
      border-bottom: 1px solid rgba(31,41,55,0.2);
      padding: 4px 2px;
    }

    .calendar-task-scope {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* SMALL TEXTS */
    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .tagline {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    #todo-add-btn {
      margin-left: auto;
      margin-top: 20px;
      padding: 0 14px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* WEEKLY TIMETABLE - ì‹œê°„ ë‹¨ìœ„ */
    .timetable-grid {
      display: grid;
      grid-template-columns: 70px repeat(7, 1fr);
      gap: 4px;
      font-size: 0.78rem;
    }

    .timetable-header {
      border-radius: 8px;
      border: 1px solid rgba(31,41,55,0.3);
      padding: 4px;
      background: var(--bg-soft);
      text-align: center;
      font-weight: 600;
    }

    .timetable-cell {
      border-radius: 8px;
      border: 1px solid rgba(31,41,55,0.3);
      padding: 4px;
      background: var(--bg-soft);
      min-height: 32px;
      word-break: break-word;
    }

    .timetable-cell[contenteditable="true"] { outline: none; }

    /* ë‹¤í¬ ëª¨ë“œì—ì„œ ê²½ê³„ì„  ë” ì„ ëª…í•˜ê²Œ */
    body:not(.theme-light) .timetable-header,
    body:not(.theme-light) .timetable-cell {
      border-color: rgba(148,163,184,0.55);
    }

    /* ë‹¬ë ¥ ê²½ê³„ì„ ë„ ì§„í•˜ê²Œ */
    body:not(.theme-light) .calendar-day,
    body:not(.theme-light) .calendar-weekday {
      border-color: rgba(148,163,184,0.55);
    }

    /* ì§‘ì¤‘ ëª¨ë“œ ë²„íŠ¼ì€ ìë™ ì‹¤í–‰ìœ¼ë¡œ ìˆ¨ê¹€ */
    #study-focus-btn { display: none; }

  </style>
</head>
<body class="theme-dark">
  <!-- ì§‘ì¤‘ ëª¨ë“œ ì˜¤ë²„ë ˆì´ -->
  <div id="focus-overlay">
    <div id="focus-overlay-inner">
      <div id="focus-title">ì§€ê¸ˆì€ ì§‘ì¤‘ ëª¨ë“œ</div>
      <div id="focus-subtitle">
        ì´ ì‹œê°„ë§Œí¼ì€ ë‹¤ë¥¸ ì•±/ì‚¬ì´íŠ¸ ìƒê° ë§ê³ ,<br />ëˆˆì•ì˜ ê³µë¶€ì—ë§Œ ì§‘ì¤‘í•´ë´ìš”.
      </div>
      <div id="focus-timer-label">--:--</div>
      <div id="focus-extra-info"></div>
      <div class="hint">
        * ì›¹ì‚¬ì´íŠ¸ëŠ” ì‹¤ì œë¡œ ë‹¤ë¥¸ ì•±ì„ ë§‰ì„ ìˆ˜ ì—†ì–´ìš”.<br />
        ëŒ€ì‹ , ì´ í™”ë©´ì„ ë³´ë©´ì„œ ë³¸ì¸ì´ ìŠ¤ìŠ¤ë¡œ ì•½ì†ì„ ì§€í‚¤ëŠ” ìš©ë„ì˜ â€œì†Œí”„íŠ¸ ì°¨ë‹¨â€ì…ë‹ˆë‹¤.
      </div>
      <button id="focus-exit-btn" style="margin-top:12px;">ì§‘ì¤‘ ëª¨ë“œ ì¢…ë£Œ</button>
      <div id="focus-hint">
        ì´ ì°½ì€ ì–¸ì œë“ ì§€ ë‹«ì„ ìˆ˜ ìˆì§€ë§Œ,<br />ê°€ëŠ¥í•˜ë©´ ê³µë¶€ ì‹œê°„ ë™ì•ˆ ê·¸ëŒ€ë¡œ ìœ ì§€í•´ ë³´ì!
      </div>
    </div>
  </div>

  <div class="app">
    <header>
      <div>
        <div class="logo">
          <span class="logo-main">My Study</span>
          <span class="logo-pill">OS</span>
        </div>
        <div id="today-label"></div>
      </div>
      <button id="theme-toggle">
        <span id="theme-icon">ğŸŒ™</span>
        <span id="theme-text">ë‹¤í¬ ëª¨ë“œ</span>
      </button>
    </header>

    <nav>
      <button class="nav-btn active" data-section="home">í™ˆ</button>
      <button class="nav-btn" data-section="todos">ê³„íš(To-do)</button>
      <button class="nav-btn" data-section="timetable">ì‹œê°„í‘œ</button>
      <button class="nav-btn" data-section="calendar">ë‹¬ë ¥</button>
      <button class="nav-btn" data-section="pomodoro">í¬ëª¨ë„ë¡œ</button>
      <button class="nav-btn" data-section="study">ê³µë¶€ íƒ€ì´ë¨¸</button>
      <button class="nav-btn" data-section="settings">ì„¤ì •</button>
    </nav>

    <main>
      <!-- HOME -->
      <section id="home" class="section active">
        <div class="grid-two">
          <div class="card">
            <div class="card-header">
              <div class="card-title">D-Day & ëª©í‘œ</div>
              <span class="pill">Home</span>
            </div>

            <div id="dday-main-label">ëª©í‘œ ë‚ ì§œì™€ ì œëª©ì„ ì„¤ì •í•´ ì£¼ì„¸ìš”.</div>
            <div id="dday-main-value">D-0</div>
            <div id="dday-main-target"></div>

            <div class="input-row" style="margin-top:10px;">
              <input type="text" id="dday-title-input" placeholder="ì˜ˆ: ê³¼í•™ê³  ì…ì‹œ" />
              <input type="date" id="dday-date-input" />
              <button id="dday-add-btn">ì¶”ê°€</button>
            </div>
            <button id="dday-clear-btn" class="secondary">ëª¨ë“  D-Day ì´ˆê¸°í™”</button>

            <input id="dday-search" class="search-input" placeholder="D-Day ê²€ìƒ‰â€¦" />

            <ul id="dday-list"></ul>

            <div class="hint">
              Â· ì—¬ëŸ¬ ê°œì˜ D-Dayë¥¼ ë“±ë¡í•  ìˆ˜ ìˆê³ , ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œê°€ ìœ„ìª½ì— í‘œì‹œë¼ìš”.<br />
              Â· D-Day ë‚ ì§œëŠ” ë‹¬ë ¥ì—ë„ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">ì˜¤ëŠ˜ì˜ ëª©í‘œ</div>
              <span class="pill">Goals</span>
            </div>
            <div class="input-row">
              <input type="text" id="goal-input" placeholder="ì˜¤ëŠ˜ ê¼­ ì´ë£¨ê³  ì‹¶ì€ ëª©í‘œë¥¼ ì ì–´ë³´ì„¸ìš”." />
              <button id="goal-add-btn">ì¶”ê°€</button>
            </div>
            <ul id="goals-list"></ul>
            <button id="goals-clear-btn" class="secondary" style="margin-top:6px;">ì „ì²´ ì‚­ì œ</button>

            <div id="home-summary">
              Â· ì˜¤ëŠ˜ ê³µë¶€ ì‹œê°„: <span id="summary-study-time">00:00:00</span><br />
              Â· ì˜¤ëŠ˜ ì™„ë£Œí•œ í•  ì¼(ëª¨ë“  ê¸°ê°„ í•©ì‚°): <span id="summary-done-count">0</span> ê°œ
            </div>
          </div>
        </div>
      </section>

      <!-- TODOS -->
      <section id="todos" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ê³„íš & ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
            <span class="pill">ì—° / ì›” / ì£¼ / ì¼</span>
          </div>

          <div id="todo-scope-tabs">
            <button class="scope-tab active" data-scope="year">1ë…„ ê³„íš</button>
            <button class="scope-tab" data-scope="month">í•œ ë‹¬ ê³„íš</button>
            <button class="scope-tab" data-scope="week">ì¼ì£¼ì¼ ê³„íš</button>
            <button class="scope-tab" data-scope="day">í•˜ë£¨ ê³„íš</button>
          </div>

          <input id="todo-search" class="search-input" placeholder="To-do ê²€ìƒ‰â€¦" />

          <div class="todo-legend">
            <span class="legend success">â— ì„±ê³µ(ì™„ë£Œ)</span>
            <span class="legend partial">â— ë¶€ë¶„ ì™„ë£Œ</span>
            <span class="legend fail">â— ì‹¤íŒ¨</span>
            <span class="legend none">â— ë¯¸ì™„ë£Œ</span>
          </div>

          <div class="input-row">
            <input type="text" id="todo-input" placeholder="ì´ ê¸°ê°„ ë™ì•ˆ í•´ì•¼ í•  ì¼ì„ ì ê³  Enter ë˜ëŠ” ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”." />
          </div>
          <div class="input-row goal-date-row">
            <div class="goal-date-group" id="todo-year-wrapper">
              <label for="todo-year">Year</label>
              <select id="todo-year"></select>
            </div>
            <div class="goal-date-group" id="todo-month-wrapper">
              <label for="todo-month">Month</label>
              <select id="todo-month"></select>
            </div>
            <div class="goal-date-group" id="todo-week-wrapper">
              <label for="todo-week">Week</label>
              <select id="todo-week">
                <option value="1">1ì£¼ì°¨</option>
                <option value="2">2ì£¼ì°¨</option>
                <option value="3">3ì£¼ì°¨</option>
                <option value="4">4ì£¼ì°¨</option>
                <option value="5">5ì£¼ì°¨</option>
              </select>
            </div>
            <div class="goal-date-group" id="todo-day-wrapper">
              <label for="todo-date-input">Date</label>
              <input type="date" id="todo-date-input" />
            </div>
            <button id="todo-add-btn" type="button">ì¶”ê°€</button>
          </div>

          <ul id="todo-list"></ul>

          <div class="hint">
            Â· â—‹: ì„±ê³µ / â–³: ì–´ëŠ ì •ë„ / âœ•: ëª» í•¨ / â–¡: ì•„ì§ í‰ê°€ ì „<br />
            Â· ë‚ ì§œë¥¼ ë„£ìœ¼ë©´ â€˜ë‹¬ë ¥â€™ íƒ­ì—ì„œ ë‚ ì§œë³„ë¡œ ê³„íšì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.
          </div>
        </div>
      </section>

      <!-- WEEKLY TIMETABLE -->
      <section id="timetable" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ì¼ì£¼ì¼ ì‹œê°„í‘œ</div>
            <span class="pill">ì‹œê°„ ë‹¨ìœ„</span>
          </div>
          <div id="timetable-grid" class="timetable-grid"></div>
          <div class="hint">
            Â· ì™¼ìª½ì€ ì‹œê°„(00:00 ~ 23:00), ìœ„ìª½ì€ ì›”~ì¼ì…ë‹ˆë‹¤.<br />
            Â· ì¹¸ì„ ëˆŒëŸ¬ ê³¼ëª©/í™œë™ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì €ì¥ë¼ìš”.
          </div>
        </div>
      </section>

      <!-- CALENDAR -->
      <section id="calendar" class="section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ë‹¬ë ¥ìœ¼ë¡œ ë³´ê¸°</div>
            <span class="pill">ê³„íš + D-Day</span>
          </div>
          <div id="calendar-month-row">
            <button id="calendar-prev-btn" class="secondary">ì´ì „</button>
            <div id="calendar-month-center">
              <div id="calendar-month-label"></div>
              <input type="month" id="calendar-month-picker" />
            </div>
            <button id="calendar-next-btn" class="secondary">ë‹¤ìŒ</button>
          </div>
          <div id="calendar-grid"></div>
          <div id="calendar-selected-date">ì„ íƒí•œ ë‚ ì§œ: ì˜¤ëŠ˜</div>
          <div id="calendar-task-list"></div>

          <button id="calendar-add-todo-btn" class="secondary" style="margin-top:6px;">
            ì´ ë‚ ì§œì— ê³„íš ì¶”ê°€
          </button>

          <div class="hint">
            Â· ê³„íš/í•  ì¼ë¿ ì•„ë‹ˆë¼ D-Dayë„ ì´ ë‹¬ë ¥ì— í‘œì‹œë¼ìš”.<br />
            Â· ì ì´ ì°íŒ ë‚ ì§œë¥¼ ëˆ„ë¥´ë©´ ì•„ë˜ì— ìƒì„¸ ëª©ë¡ì´ ëœ¹ë‹ˆë‹¤.
          </div>
        </div>
      </section>

      <!-- POMODORO -->
      <section id="pomodoro" class="section">
        <div class="grid-two">
          <div class="card">
            <div class="card-header">
              <div class="card-title">í¬ëª¨ë„ë¡œ íƒ€ì´ë¨¸</div>
              <span class="pill">ì§‘ì¤‘/íœ´ì‹ ì‚¬ì´í´</span>
            </div>
            <div id="pomo-display">25:00</div>
            <div id="pomo-phase">ëŒ€ê¸° ì¤‘</div>
            <div id="pomo-controls">
              <button id="pomo-start-btn">ì‹œì‘</button>
              <button id="pomo-pause-btn" class="secondary">ì¼ì‹œ ì •ì§€</button>
              <button id="pomo-reset-btn" class="secondary">ë¦¬ì…‹</button>
            </div>
            <div id="pomo-progress-text">0 / 4 ì‚¬ì´í´</div>
            <div class="hint">
              ê¸°ë³¸ ì„¤ì •: 25ë¶„ ì§‘ì¤‘ â†’ 5ë¶„ íœ´ì‹ Ã— 4ì‚¬ì´í´ â†’ 10ë¶„ ê¸´ íœ´ì‹<br />
              ì§‘ì¤‘/ì‰¬ëŠ” ì‹œê°„, ì‚¬ì´í´ ìˆ˜ëŠ” ì˜¤ë¥¸ìª½ì—ì„œ ììœ ë¡­ê²Œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">í¬ëª¨ë„ë¡œ ì„¤ì •</div>
              <span class="pill">ì‚¬ìš©ì ì„¤ì •</span>
            </div>
            <div id="pomo-config-grid">
              <div class="config-item">
                <label for="pomo-focus-min">ì§‘ì¤‘ ì‹œê°„(ë¶„)</label>
                <input type="number" id="pomo-focus-min" min="1" max="180" value="25" />
              </div>
              <div class="config-item">
                <label for="pomo-short-min">ì§§ì€ íœ´ì‹(ë¶„)</label>
                <input type="number" id="pomo-short-min" min="1" max="60" value="5" />
              </div>
              <div class="config-item">
                <label for="pomo-long-min">ê¸´ íœ´ì‹(ë¶„)</label>
                <input type="number" id="pomo-long-min" min="1" max="120" value="10" />
              </div>
              <div class="config-item">
                <label for="pomo-cycles">ê¸´ íœ´ì‹ ì „ ì‚¬ì´í´ ìˆ˜</label>
                <input type="number" id="pomo-cycles" min="1" max="12" value="4" />
              </div>
            </div>
            <button id="pomo-save-config-btn" style="margin-top:8px;">ì„¤ì • ì €ì¥</button>
            <div class="hint">
              * ì„¤ì •ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë¼ì„œ, ë‹¤ìŒì— ë“¤ì–´ì™€ë„ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </section>

      <!-- STUDY TIMER -->
      <section id="study" class="section">
        <div class="grid-two">
          <div class="card">
            <div class="card-header">
              <div class="card-title">ì˜¤ëŠ˜ ê³µë¶€ ì‹œê°„</div>
              <span class="pill">ì§‘ì¤‘ ê¸°ë¡</span>
            </div>
            <div id="study-time-today">00:00:00</div>
            <div id="study-status">ëŒ€ê¸° ì¤‘</div>
            <div id="study-controls">
              <button id="study-start-btn">ì‹œì‘</button>
              <button id="study-stop-btn" class="secondary">ì •ì§€</button>
              <button id="study-reset-btn" class="secondary">ì˜¤ëŠ˜ ê¸°ë¡ ì´ˆê¸°í™”</button>
              <button id="study-focus-btn" class="secondary">ì§‘ì¤‘ ëª¨ë“œ ì¼œê¸°</button>
            </div>
            <div id="study-log">
              Â· í˜„ì¬ ì„¸ì…˜ ì‹œê°„: <span id="study-session-time">00:00:00</span><br />
              Â· ìµœê·¼ ì„¸ì…˜ ê¸¸ì´: <span id="study-last-session">-</span>
            </div>
            <div class="hint">
              * â€œì‹œì‘â€ì„ ëˆ„ë¥´ë©´ ê³µë¶€ ì‹œê°„ ê¸°ë¡ì´ ì‹œì‘ë˜ê³ , â€œì •ì§€â€ë¥¼ ëˆ„ë¥´ë©´ ì˜¤ëŠ˜ ì´ ê³µë¶€ ì‹œê°„ì— ë”í•´ì§‘ë‹ˆë‹¤.<br />
              * ì§‘ì¤‘ ëª¨ë“œì—ì„œ ë‚˜ê°€ë©´, ì •ì§€ë¥¼ ëˆ„ë¥´ì§€ ì•Šì•„ë„ í˜„ì¬ ì„¸ì…˜ì€ ìë™ìœ¼ë¡œ ì¢…ë£Œë¼ìš”.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">ì§‘ì¤‘ ëª¨ë“œ ì•ˆë‚´</div>
              <span class="pill">ì§‘ì¤‘ í™”ë©´</span>
            </div>
            <p class="tagline">
              ì§„ì§œ ì•± ì°¨ë‹¨ê¹Œì§€ëŠ” ëª» í•˜ì§€ë§Œ,<br />
              ì´ ì›¹ì‚¬ì´íŠ¸ ì•ˆì—ì„œë§Œí¼ì€ â€œê³µë¶€ë§Œ í•˜ë„ë¡â€ ë•ëŠ” ëª¨ë“œì˜ˆìš”.
            </p>
            <ul style="margin-top:8px;font-size:0.82rem;color:var(--text-muted);line-height:1.5;">
              <li>Â· ê³µë¶€ íƒ€ì´ë¨¸/í¬ëª¨ë„ë¡œë¥¼ ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ ì§‘ì¤‘ í™”ë©´ì´ ë– ìš”.</li>
              <li>Â· ê³µë¶€ íƒ€ì´ë¨¸: í˜„ì¬ ì„¸ì…˜ ì‹œê°„ + ì˜¤ëŠ˜ ì´ ê³µë¶€ ì‹œê°„ í‘œì‹œ.</li>
              <li>Â· í¬ëª¨ë„ë¡œ: ì˜¤ëŠ˜ ëª‡ ë²ˆì§¸ í¬ëª¨ë„ë¡œì¸ì§€ì™€ ë‚¨ì€ ì‹œê°„/ìƒíƒœ í‘œì‹œ.</li>
              <li>Â· ì§‘ì¤‘ ëª¨ë“œ ì¢…ë£Œë¥¼ ëˆ„ë¥´ë©´, ê³µë¶€ ì„¸ì…˜ì€ ìë™ìœ¼ë¡œ ë©ˆì¶”ê³ (í¬ëª¨ë„ë¡œëŠ” ì¼ì‹œì •ì§€) ê¸°ë¡ë©ë‹ˆë‹¤.</li>
            </ul>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">ë¶„ëŸ‰ ê³„ì‚°ê¸°</div>
              <span class="pill">ë¬¸ì œ / í˜ì´ì§€</span>
            </div>

            <div class="input-row">
              <label style="font-size:0.8rem; margin-bottom:4px;">ë‹¨ìœ„ ì„ íƒ</label>
              <select id="plan-unit" style="width:100%; padding:6px 8px; border-radius:9px; border:1px solid var(--border-subtle); background:var(--bg-soft); color:var(--text); font-size:0.8rem;">
                <option value="problem">ë¬¸ì œ ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ê¸°</option>
                <option value="page">í˜ì´ì§€ ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ê¸°</option>
              </select>
            </div>

            <div class="input-row">
              <label for="plan-total" style="font-size:0.8rem; margin-bottom:4px;">ì´ ë¬¸ì œ ìˆ˜ / í˜ì´ì§€ ìˆ˜</label>
              <input type="number" id="plan-total" min="1" placeholder="ì˜ˆ: 120" />
            </div>

            <div class="input-row goal-date-row">
              <div class="goal-date-group">
                <label for="plan-deadline">ì–¸ì œê¹Œì§€?</label>
                <input type="date" id="plan-deadline" />
              </div>
              <div class="goal-date-group">
                <label for="plan-weekly-count">ì¼ì£¼ì¼ì— ëª‡ ë²ˆ?</label>
                <input type="number" id="plan-weekly-count" min="1" max="14" placeholder="ì˜ˆ: 3" />
              </div>
              <button id="plan-calc-btn" type="button">ê³„ì‚°í•˜ê¸°</button>
            </div>

            <div id="plan-result" class="hint" style="margin-top:6px;">
              Â· ì´ ë¶„ëŸ‰ê³¼ ë§ˆê°ì¼, ì£¼ë‹¹ íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ 1íšŒì— ëª‡ ë¬¸ì œ/í˜ì´ì§€ì”© í•´ì•¼ í• ì§€ ê³„ì‚°í•´ ì¤„ê²Œìš”.
            </div>
          </div>

        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="section">
        <div class="grid-two">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Google ê³„ì • & ë°ì´í„° ë°±ì—…</div>
              <span class="pill">Cloud Backup</span>
            </div>
            <p class="tagline">
              Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê³ , í˜„ì¬ ê¸°ê¸°ì˜ ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œì— ë°±ì—…í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </p>

            <div id="google-status" class="hint" style="margin-top:8px;">
              ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>

            <div class="input-row" style="margin-top: 10px;">
              <button id="google-login-btn">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
              <button id="google-logout-btn" class="secondary">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <hr style="margin:12px 0; border-color:rgba(148,163,184,0.4);" />

            <p class="tagline">
              ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œ ë˜ëŠ” ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </p>

            <div class="input-row" style="margin-top:10px;">
              <button id="cloud-backup-btn" class="secondary">í´ë¼ìš°ë“œì— ë°±ì—…</button>
              <button id="cloud-restore-btn" class="secondary">í´ë¼ìš°ë“œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>

            <div class="hint" style="margin-top:8px;">
              Â· ë°±ì—…: ì´ ë¸Œë¼ìš°ì €ì˜ ë°ì´í„°ë¥¼ í†µì§¸ë¡œ Firestoreì— ì €ì¥<br>
              Â· ë¶ˆëŸ¬ì˜¤ê¸°: Firestore ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì´ ê¸°ê¸°ì— ë®ì–´ì“´ í›„ ìƒˆë¡œê³ ì¹¨
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">í…Œë§ˆ & í™”ë©´ ìœ ì§€</div>
              <span class="pill">Theme</span>
            </div>
            <p class="tagline">
              ë¼ì´íŠ¸/ë‹¤í¬ í…Œë§ˆë¥¼ ì „í™˜í•˜ê³ , ê°€ëŠ¥í•œ ë²”ìœ„ ì•ˆì—ì„œ í™”ë©´ì´ êº¼ì§€ì§€ ì•Šë„ë¡ ì‹œë„í•©ë‹ˆë‹¤.
            </p>
            <div class="hint" style="margin-top:6px;">
              Â· ìƒë‹¨ì˜ ë²„íŠ¼ìœ¼ë¡œ í…Œë§ˆë¥¼ ì „í™˜í•  ìˆ˜ ìˆì–´ìš”.<br />
              Â· íƒ€ì´ë¨¸(í¬ëª¨ë„ë¡œ/ê³µë¶€)ê°€ ëŒì•„ê°€ëŠ” ë™ì•ˆì—ëŠ” ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ í™”ë©´ êº¼ì§ì„ ë§‰ë„ë¡ ìš”ì²­í•´ìš”.<br />
              Â· iPad Safariì—ì„œëŠ” ì´ ê¸°ëŠ¥ì´ ì œí•œì ì¼ ìˆ˜ ìˆì–´ìš”.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">ì•Œë¦¼ ì„¤ì •</div>
              <span class="pill">Notification</span>
            </div>
            <p class="tagline">
              í¬ëª¨ë„ë¡œ ì¢…ë£Œ, ë‚´ì¼ D-Day, ê³µë¶€ ì‹œì‘ ì‹œê°„ì— ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.
            </p>

            <div class="input-row" style="margin-top:8px;">
              <button id="notify-permission-btn">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</button>
            </div>

            <div class="hint" style="margin-top:4px;">
              Â· ë¨¼ì € â€œì•Œë¦¼ ê¶Œí•œ ìš”ì²­â€ì„ ëˆŒëŸ¬ ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.<br />
              Â· iOS/Safari ë“± ì¼ë¶€ í™˜ê²½ì—ì„œëŠ” ì•Œë¦¼ì´ ì œí•œë  ìˆ˜ ìˆì–´ìš”.
            </div>

            <hr style="margin:10px 0; border-color:rgba(148,163,184,0.4);" />

            <p class="tagline">ë‚´ì¼ì´ D-Dayì¼ ë•Œ, ì•Œë¦¼ì´ ìš¸ë¦´ ì‹œê°„ì„ ì •í•´ìš”.</p>
            <div class="input-row" style="margin-top:6px;">
              <input type="time" id="dday-reminder-time" />
              <button id="dday-reminder-save-btn" class="secondary">D-Day ì‹œê°„ ì €ì¥</button>
            </div>

            <p class="tagline" style="margin-top:10px;">ë§¤ì¼ ê³µë¶€ë¥¼ ì‹œì‘í•˜ë¼ê³  ì•Œë ¤ì¤„ ì‹œê°„ì„ ì •í•´ìš”.</p>
            <div class="input-row" style="margin-top:6px;">
              <input type="time" id="study-reminder-time" />
              <button id="study-reminder-save-btn" class="secondary">ê³µë¶€ ì‹œê°„ ì €ì¥</button>
            </div>

            <div class="hint" style="margin-top:6px;">
              Â· ë‚´ì¼ì´ D-Dayì¸ ì¼ì •ì´ ìˆì„ ë•Œë§Œ, ì„¤ì •í•œ ì‹œê°ì— D-Day ì•Œë¦¼ì´ ìš¸ë¦½ë‹ˆë‹¤.<br />
              Â· ê³µë¶€ ì‹œì‘ ì‹œê°„ì€ ë§¤ì¼ ê°™ì€ ì‹œê°ì— í•œ ë²ˆ ì•Œë¦¼ì´ ìš¸ë¦½ë‹ˆë‹¤(ì•±ì´ ì¼œì ¸ ìˆì„ ë•Œ).
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">ê°•ì œ ìƒˆë²„ì „ ê°±ì‹ </div>
              <span class="pill">Developer</span>
            </div>
            <p class="tagline">
              ìºì‹œì™€ ì„œë¹„ìŠ¤ì›Œì»¤ë¥¼ ì œê±°í•˜ê³  ìµœì‹  ë²„ì „ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
            </p>

            <button id="hard-reload-btn" class="secondary" style="margin-top:10px;">
              ê°•ì œ ìƒˆë²„ì „ ë¡œë“œ
            </button>

            <div class="hint" style="margin-top:8px;">
              â€» ìºì‹œ/ì„œë¹„ìŠ¤ì›Œì»¤ê°€ ì¦‰ì‹œ ì‚­ì œë˜ì–´ ìƒˆë¡œìš´ ì½”ë“œê°€ ìë™ ì ìš©ë©ë‹ˆë‹¤.  
              (ê°œë°œ ì‹œ ë§¤ìš° ìœ ìš©)
              â€» ì—…ë°ì´íŠ¸ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìë™ì´ì§€ë§Œ ê°€ë” ì—…ë°ì´íŠ¸ê°€ ë˜ì–´ ìˆì§€ ì•Šì„ ìˆ˜ ìˆì–´ ì—…ë°ì´íŠ¸ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">ë°ì´í„° ì´ˆê¸°í™”</div>
              <span class="pill">Reset</span>
            </div>
            <p class="tagline">ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ëª¨ë“  ê¸°ë¡ì„ ì§€ìš°ê³  ì²˜ìŒ ìƒíƒœë¡œ ëŒë¦¬ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
            <button id="reset-all-btn" class="danger" style="margin-top:10px;">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
            <div class="hint">
              * D-Day, ëª©í‘œ, ëª¨ë“  To-do, ê³µë¶€ ì‹œê°„, í¬ëª¨ë„ë¡œ ì„¤ì • ë“±ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.<br />
              * ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë‹ˆ ì‹ ì¤‘í•˜ê²Œ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">í•  ì¼ ì²´í¬ ìŠ¤íƒ€ì¼</div>
              <span class="pill">To-do í‘œì‹œ</span>
            </div>
            <p class="tagline">
              ì²´í¬ë°•ìŠ¤ì— ê¸°í˜¸ë¥¼ ì‚¬ìš©í• ì§€, ìƒ‰ë§Œ ê½‰ ì±„ì›Œì„œ ì‚¬ìš©í• ì§€ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”.
            </p>
            <div class="input-row" style="margin-top:8px;font-size:0.8rem;">
              <label style="display:flex;align-items:center;gap:4px;">
                <input type="radio" name="todo-style" value="symbol" checked />
                ê¸°í˜¸
              </label>
              <label style="display:flex;align-items:center;gap:4px;">
                <input type="radio" name="todo-style" value="color-only" />
                ìƒ‰ë§Œ ì‚¬ìš©
              </label>
            </div>
            <div class="hint">
              Â· ìƒ‰ë§Œ ì‚¬ìš©: ë„¤ëª¨ì¹¸ ì „ì²´ê°€ ìƒ‰ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤(ê¸°í˜¸ ì—†ìŒ).<br />
              Â· ê¸°í˜¸: â—‹/â–³/âœ•/â–¡ ê¸°í˜¸ì™€ ìƒ‰ìœ¼ë¡œ ìƒíƒœë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.
            </div>
          </div>

          <!-- ì•Œë¦¼ ê¸°ëŠ¥ ì£¼ì˜ì‚¬í•­ ì¹´ë“œ -->
          <div style="
            margin-top: 22px;
            padding: 18px;
            background: #1e1e1e;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            color: #eaeaea;
            font-size: 14px;
            line-height: 1.55;
            box-shadow: 0 4px 12px rgba(0,0,0,0.35);
          ">

            <div style="font-weight: 700; font-size: 15px; margin-bottom: 8px;">
              âš ï¸ ì•Œë¦¼ ê¸°ëŠ¥ ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­
            </div>

            <div style="margin-bottom: 14px;">
              <b>â€¢ ì•ˆë“œë¡œì´ë“œ ì ˆì „ ëª¨ë“œ</b><br>
              ì•ˆë“œë¡œì´ë“œ ê¸°ê¸°ì—ì„œ ì ˆì „ ëª¨ë“œë¥¼ í™œì„±í™”í•˜ë©´ My Study OSì˜ ë°±ê·¸ë¼ìš´ë“œ ë™ì‘(í¬ëª¨ë„ë¡œÂ·ê³µë¶€ ì‹œì‘Â·D-Day ì²´í¬)ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
              ì´ ê²½ìš° ì•Œë¦¼ì´ ì œë•Œ ì „ë‹¬ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <div style="margin-bottom: 14px;">
              <b>â€¢ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í•„ìš” ì¡°ê±´</b><br>
              ì•Œë¦¼ì€ Cloudflare Worker â†’ FCM ì„œë²„ë¥¼ í†µí•´ ì „ì†¡ë˜ë¯€ë¡œ,<br>
              <b>í‘¸ì‹œê°€ ë³´ë‚´ì§€ëŠ” ìˆœê°„</b> ê¸°ê¸°ê°€ ì™€ì´íŒŒì´ ë˜ëŠ” ëª¨ë°”ì¼ ë°ì´í„°ì— ì—°ê²°ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.<br>
              <span style="color:#ffd54f;"><b>ë‹¨, ì•± ìì²´ ê¸°ëŠ¥(í¬ëª¨ë„ë¡œÂ·D-Day ê³„ì‚°Â·ê³µë¶€ ì‹œì‘ ì‹œê°„ ê³„ì‚°)ì€ ì˜¤í”„ë¼ì¸ì—ì„œë„ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.</b></span>
            </div>

            <div>
              <b>â€¢ ì•±(íƒ­) ì¢…ë£Œ ì£¼ì˜</b><br>
              í™ˆ í™”ë©´ì— ì¶”ê°€í•´ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ì•± ì „í™˜ í™”ë©´ì—ì„œ My Study OSë¥¼ ìœ„ë¡œ ìŠ¤ì™€ì´í”„í•˜ì—¬ ì¢…ë£Œí•˜ì§€ ì•ŠëŠ” í•œ<br>
              ë°±ê·¸ë¼ìš´ë“œì—ì„œë„ ì•Œë¦¼ ê³„ì‚° ê¸°ëŠ¥ì€ ê³„ì† ì‘ë™í•©ë‹ˆë‹¤.<br>
              ê·¸ëŸ¬ë‚˜ ì•±ì„ ì™„ì „íˆ ì¢…ë£Œí•˜ë©´ ì•Œë¦¼ ê³„ì‚°ì´ ì¤‘ë‹¨ë˜ì–´ í‘¸ì‹œê°€ ë°œì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== ê³µí†µ: ë‚ ì§œ í¬ë§· =====
    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    // ===== ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ =====
    const todayLabel = document.getElementById("today-label");
    const today = new Date();
    let studyLog = {};
    const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    todayLabel.textContent =
      `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")} (${dayNames[today.getDay()]})`;

    // ===== í…Œë§ˆ í† ê¸€ =====
    const themeToggleBtn = document.getElementById("theme-toggle");
    const themeIcon = document.getElementById("theme-icon");
    const themeText = document.getElementById("theme-text");
    const THEME_KEY = "study_os_theme";

    function applyTheme(theme) {
      if (theme === "light") {
        document.body.classList.add("theme-light");
        themeIcon.textContent = "â˜€ï¸";
        themeText.textContent = "ë¼ì´íŠ¸ ëª¨ë“œ";
      } else {
        document.body.classList.remove("theme-light");
        themeIcon.textContent = "ğŸŒ™";
        themeText.textContent = "ë‹¤í¬ ëª¨ë“œ";
      }
      localStorage.setItem(THEME_KEY, theme);
    }

    const savedTheme = localStorage.getItem(THEME_KEY) || "dark";
    applyTheme(savedTheme);

    themeToggleBtn.addEventListener("click", () => {
      const current = localStorage.getItem(THEME_KEY) || "dark";
      applyTheme(current === "dark" ? "light" : "dark");
    });

        // ===== ì•Œë¦¼ ê¶Œí•œ & ë¡œì»¬ ì•Œë¦¼ =====
    async function requestNotificationPermission() {
      if (!("Notification" in window)) {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
        return;
      }

      try {
        const permission = await Notification.requestPermission();
        if (permission === "granted") {
          alert("ì•Œë¦¼ì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
        } else if (permission === "denied") {
          alert("ì•Œë¦¼ì´ ì°¨ë‹¨ë˜ì–´ ìˆì–´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.");
        }
      } catch (e) {
        console.error("ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜", e);
      }
    }

    function showLocalNotification(title, body) {
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;

      try {
        new Notification(title, {
          body,
          icon: "/My-Study-OS/icon-192.png", // manifestì—ì„œ ì“°ëŠ” ì•„ì´ì½˜ ê²½ë¡œì— ë§ê²Œ ìˆ˜ì • ê°€ëŠ¥
        });
      } catch (e) {
        console.error("ì•Œë¦¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜", e);
      }
    }

    // ===== ë„¤ë¹„ê²Œì´ì…˜ =====
    const navButtons = document.querySelectorAll(".nav-btn");
    const sections = document.querySelectorAll(".section");
    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.section;
        navButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        sections.forEach((sec) => {
          sec.classList.toggle("active", sec.id === target);
        });
      });
    });

    // ===== ë¦¬ìŠ¤íŠ¸ ê²€ìƒ‰ ê³µí†µ í•¨ìˆ˜ =====
    function setupSearch(inputId, listId) {
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      if (!input || !list) return;

      input.addEventListener("input", () => {
        const keyword = input.value.trim().toLowerCase();
        const items = list.querySelectorAll("li");

        items.forEach((li) => {
          const text = li.textContent.toLowerCase();
          li.style.display = text.includes(keyword) ? "" : "none";
        });
      });
    }

    // ===== To-do ì²´í¬ìŠ¤íƒ€ì¼ ì„¤ì • =====
    const TODO_STYLE_KEY = "study_os_todo_style";
    let todoStyle = localStorage.getItem(TODO_STYLE_KEY) || "symbol";

    // ===== ì•Œë¦¼ ë§ˆì§€ë§‰ ì‹¤í–‰ ë‚ ì§œ ì €ì¥ =====
    const LAST_DDAY_NOTIFY_KEY = "study_os_last_dday_notify";
    const LAST_STUDY_NOTIFY_KEY = "study_os_last_study_notify";

    let lastDdayNotifyDateStr = localStorage.getItem(LAST_DDAY_NOTIFY_KEY) || "";
    let lastStudyNotifyDateStr = localStorage.getItem(LAST_STUDY_NOTIFY_KEY) || "";

    // ===== ì•Œë¦¼ ì„¤ì • (ì‹œê°„ ì €ì¥ & ë²„íŠ¼ ì—°ê²°) =====
    const DDAY_REMINDER_TIME_KEY = "study_os_dday_reminder_time";
    const STUDY_REMINDER_TIME_KEY = "study_os_study_reminder_time";

    let ddayReminderTime = localStorage.getItem(DDAY_REMINDER_TIME_KEY) || "";
    let studyReminderTime = localStorage.getItem(STUDY_REMINDER_TIME_KEY) || "";

    const notifyPermissionBtn = document.getElementById("notify-permission-btn");
    const ddayReminderInput = document.getElementById("dday-reminder-time");
    const ddayReminderSaveBtn = document.getElementById("dday-reminder-save-btn");
    const studyReminderInput = document.getElementById("study-reminder-time");
    const studyReminderSaveBtn = document.getElementById("study-reminder-save-btn");

    if (notifyPermissionBtn) {
      notifyPermissionBtn.addEventListener("click", () => {
        requestNotificationPermission();
      });
    }

    if (ddayReminderInput && ddayReminderSaveBtn) {
      if (ddayReminderTime) {
        ddayReminderInput.value = ddayReminderTime;
      }
      ddayReminderSaveBtn.addEventListener("click", () => {
        ddayReminderTime = ddayReminderInput.value;
        localStorage.setItem(DDAY_REMINDER_TIME_KEY, ddayReminderTime || "");
        alert("D-Day ì•Œë¦¼ ì‹œê°„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      });
    }

    if (studyReminderInput && studyReminderSaveBtn) {
      if (studyReminderTime) {
        studyReminderInput.value = studyReminderTime;
      }
      studyReminderSaveBtn.addEventListener("click", () => {
        studyReminderTime = studyReminderInput.value;
        localStorage.setItem(STUDY_REMINDER_TIME_KEY, studyReminderTime || "");

        console.log("[DEBUG] ì €ì¥ëœ studyReminderTime =", studyReminderTime);

        alert("ê³µë¶€ ì‹œì‘ ì•Œë¦¼ ì‹œê°„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      });
    }

    // ===== D-DAY (ì—¬ëŸ¬ ê°œ) =====
    const DDAY_LIST_KEY = "study_os_ddays_v1";

    const PINNED_DDAY_KEY = "study_os_pinned_dday_id";

    function getPinnedDdayId() {
      const v = localStorage.getItem(PINNED_DDAY_KEY);
      return v ? Number(v) : null;
    }

    function setPinnedDdayId(id) {
      if (id == null) {
        localStorage.removeItem(PINNED_DDAY_KEY);
      } else {
        localStorage.setItem(PINNED_DDAY_KEY, String(id));
      }
    }

    const LEGACY_DDAY_KEY = "study_os_dday"; // ì˜ˆì „ ë‹¨ì¼ D-Day í‚¤

    const ddayMainLabelEl = document.getElementById("dday-main-label");
    const ddayMainValueEl = document.getElementById("dday-main-value");
    const ddayMainTargetEl = document.getElementById("dday-main-target");
    const ddayTitleInput = document.getElementById("dday-title-input");
    const ddayDateInput = document.getElementById("dday-date-input");
    const ddayAddBtn = document.getElementById("dday-add-btn");
    const ddayClearBtn = document.getElementById("dday-clear-btn");
    const ddayListEl = document.getElementById("dday-list");

    let ddayItems = [];

    function loadDDays() {
      try {
        const savedList = localStorage.getItem(DDAY_LIST_KEY);
        if (savedList) {
          ddayItems = JSON.parse(savedList);
        } else {
          // ì˜ˆì „ ë²„ì „ ë‹¨ì¼ D-Dayë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
          const legacy = localStorage.getItem(LEGACY_DDAY_KEY);
          if (legacy) {
            const obj = JSON.parse(legacy);
            if (obj && obj.date) {
              ddayItems = [{
                id: Date.now(),
                title: obj.title || "ëª©í‘œ",
                date: obj.date
              }];
              saveDDays();
            }
          }
        }
      } catch {
        ddayItems = [];
      }
    }

    function saveDDays() {
      localStorage.setItem(DDAY_LIST_KEY, JSON.stringify(ddayItems));
    }

    function addDDay() {
      const title = ddayTitleInput.value.trim();
      const dateStr = ddayDateInput.value;
      if (!title || !dateStr) {
        alert("ì œëª©ê³¼ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }
      ddayItems.push({
        id: Date.now() + Math.random(),
        title,
        date: dateStr
      });
      ddayTitleInput.value = "";
      ddayDateInput.value = "";
      saveDDays();
      renderDDays();
      renderCalendar(); // ë‹¬ë ¥ ì  ê°±ì‹ 
      renderCalendarSelectedTasks(selectedCalendarDateStr);
    }

    function renderDDays() {
      if (!ddayItems.length) {
        ddayMainLabelEl.textContent = "ëª©í‘œ ë‚ ì§œì™€ ì œëª©ì„ ì„¤ì •í•´ ì£¼ì„¸ìš”.";
        ddayMainValueEl.textContent = "D-0";
        ddayMainTargetEl.textContent = "";
        ddayListEl.innerHTML = "";
        return;
      }

      const pinnedId = getPinnedDdayId();

      // ë‚ ì§œ + í•€ ê¸°ì¤€ ì •ë ¬
      const sorted = [...ddayItems].sort((a, b) => {
        if (a.id === pinnedId) return -1;
        if (b.id === pinnedId) return 1;
        return new Date(a.date) - new Date(b.date);
      });

      const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      let defaultMain = sorted[0];

      // ê°€ì¥ ê°€ê¹Œìš´ ë¯¸ë˜/ì˜¤ëŠ˜ D-Day ì°¾ê¸°
      for (const item of sorted) {
        const d = new Date(item.date);
        const dOnly = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        if (dOnly >= todayOnly) {
          defaultMain = item;
          break;
        }
      }

      // í•€ ë˜ì–´ ìˆìœ¼ë©´ ê·¸ê±¸ ë©”ì¸ìœ¼ë¡œ, ì—†ìœ¼ë©´ ê¸°ì¡´ ë¡œì§
      const pinnedMain = sorted.find((item) => item.id === pinnedId);
      const main = pinnedMain || defaultMain;

      const targetDate = new Date(main.date);
      const targetDayOnly = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
      const diffMs = targetDayOnly - todayOnly;
      const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

      let label = "";
      if (diffDays > 0) label = `D-${diffDays}`;
      else if (diffDays === 0) label = "D-DAY";
      else label = `D+${Math.abs(diffDays)}`;

      ddayMainLabelEl.textContent = main.title || "ëª©í‘œ";
      ddayMainValueEl.textContent = label;
      ddayMainTargetEl.textContent = `${main.date} ê¹Œì§€`;

      // ë¦¬ìŠ¤íŠ¸ ë Œë”
      ddayListEl.innerHTML = "";
      sorted.forEach((item) => {
        const li = document.createElement("li");
        li.className = "dday-item";

        const info = document.createElement("div");
        const mainSpan = document.createElement("div");
        const diff = Math.round(
          (new Date(item.date).setHours(0,0,0,0) - todayOnly.getTime()) /
          (1000*60*60*24)
        );
        let tag = "";
        if (diff > 0) tag = `D-${diff}`;
        else if (diff === 0) tag = "D-DAY";
        else tag = `D+${Math.abs(diff)}`;

        mainSpan.className = "dday-text-main";
        mainSpan.textContent = `${tag} Â· ${item.title}`;
        const subSpan = document.createElement("div");
        subSpan.className = "dday-text-sub";
        subSpan.textContent = item.date;

        info.appendChild(mainSpan);
        info.appendChild(subSpan);

        const delBtn = document.createElement("button");
        delBtn.className = "tiny";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", () => {
          ddayItems = ddayItems.filter((d) => d.id !== item.id);
          saveDDays();
          renderDDays();
          renderCalendar();
          renderCalendarSelectedTasks(selectedCalendarDateStr);
        });

        const pinnedId = getPinnedDdayId();

        const pinBtn = document.createElement("button");
        pinBtn.className = "tiny";
        pinBtn.textContent = item.id === pinnedId ? "â˜… ê³ ì •ë¨" : "â˜† ê³ ì •";

        pinBtn.addEventListener("click", () => {
          setPinnedDdayId(item.id);
          renderDDays();                                    // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
          renderCalendarSelectedTasks(selectedCalendarDateStr);  // ì•„ë˜ íŒ¨ë„ ê°±ì‹ 
        });

        // ì˜¤ë¥¸ìª½ ë²„íŠ¼ ì˜ì—­
        const btnWrap = document.createElement("div");
        btnWrap.style.display = "flex";
        btnWrap.style.flexDirection = "column";
        btnWrap.style.gap = "4px";
        btnWrap.appendChild(pinBtn);
        btnWrap.appendChild(delBtn);

        li.appendChild(info);
        li.appendChild(btnWrap);
        ddayListEl.appendChild(li);
      });
    }

    ddayAddBtn.addEventListener("click", addDDay);
    ddayClearBtn.addEventListener("click", () => {
      if (!confirm("ëª¨ë“  D-Dayë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      ddayItems = [];
      saveDDays();
      renderDDays();
      renderCalendar();
      renderCalendarSelectedTasks(selectedCalendarDateStr);
    });

    // ===== Goals =====
    const GOALS_KEY = "study_os_goals";
    const goalInput = document.getElementById("goal-input");
    const goalAddBtn = document.getElementById("goal-add-btn");
    const goalsList = document.getElementById("goals-list");
    const goalsClearBtn = document.getElementById("goals-clear-btn");

    let goals = [];
    function loadGoals() {
      try {
        const saved = localStorage.getItem(GOALS_KEY);
        goals = saved ? JSON.parse(saved) : [];
      } catch {
        goals = [];
      }
    }
    function saveGoals() {
      localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
    }
    function renderGoals() {
      goalsList.innerHTML = "";
      goals.forEach((g, idx) => {
        const li = document.createElement("li");
        li.className = "goal-item";
        const span = document.createElement("span");
        span.className = "goal-text";
        span.textContent = g;
        const btn = document.createElement("button");
        btn.className = "tiny";
        btn.textContent = "ì‚­ì œ";
        btn.addEventListener("click", () => {
          goals.splice(idx, 1);
          saveGoals();
          renderGoals();
        });
        li.appendChild(span);
        li.appendChild(btn);
        goalsList.appendChild(li);
      });
    }
    function addGoal() {
      const text = goalInput.value.trim();
      if (!text) return;
      goals.push(text);
      goalInput.value = "";
      saveGoals();
      renderGoals();
    }

    goalAddBtn.addEventListener("click", addGoal);
    goalInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addGoal();
    });
    goalsClearBtn.addEventListener("click", () => {
      if (!confirm("ì˜¤ëŠ˜ ëª©í‘œë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
      goals = [];
      saveGoals();
      renderGoals();
    });

    loadGoals();
    loadDDays();
    renderDDays();
    renderGoals();
    setupSearch("dday-search", "dday-list");

    // ===== To-do =====
    const TODOS_KEY = "study_os_todos_v1";
    const scopeTabs = document.querySelectorAll(".scope-tab");
    const todoInput = document.getElementById("todo-input");
    const todoDateInput = document.getElementById("todo-date-input");
    const todoAddBtn = document.getElementById("todo-add-btn");
    const todoListEl = document.getElementById("todo-list");
    const todoYearWrapper = document.getElementById("todo-year-wrapper");
    const todoMonthWrapper = document.getElementById("todo-month-wrapper");
    const todoWeekWrapper = document.getElementById("todo-week-wrapper");
    const todoDayWrapper = document.getElementById("todo-day-wrapper");
    const todoYearSelect = document.getElementById("todo-year");
    const todoMonthSelect = document.getElementById("todo-month");
    const todoWeekSelect = document.getElementById("todo-week");

    let todoData = {
      year: [],
      month: [],
      week: [],
      day: [],
    };
    let currentScope = "year";

    const baseYear = today.getFullYear();
    for (let y = baseYear - 2; y <= baseYear + 5; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      todoYearSelect.appendChild(opt);
    }

    for (let m = 1; m <= 12; m++) {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      todoMonthSelect.appendChild(opt);
    }

    todoYearSelect.value = String(baseYear);
    todoMonthSelect.value = String(today.getMonth() + 1);

    function updateTodoDateInputs() {
      if (currentScope === "year") {
        todoYearWrapper.style.display = "flex";
        todoMonthWrapper.style.display = "none";
        todoWeekWrapper.style.display = "none";
        todoDayWrapper.style.display = "none";
      } else if (currentScope === "month") {
        todoYearWrapper.style.display = "flex";
        todoMonthWrapper.style.display = "flex";
        todoWeekWrapper.style.display = "none";
        todoDayWrapper.style.display = "none";
      } else if (currentScope === "week") {
        todoYearWrapper.style.display = "flex";
        todoMonthWrapper.style.display = "flex";
        todoWeekWrapper.style.display = "flex";
        todoDayWrapper.style.display = "none";
      } else {
        todoYearWrapper.style.display = "none";
        todoMonthWrapper.style.display = "none";
        todoWeekWrapper.style.display = "none";
        todoDayWrapper.style.display = "flex";
        if (!todoDateInput.value) {
          todoDateInput.value = formatDate(today);
        }
      }
    }

    function loadTodos() {
      try {
        const saved = localStorage.getItem(TODOS_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          todoData = Object.assign(todoData, parsed);
        }
      } catch {
        // ignore
      }
    }

    function saveTodos() {
      localStorage.setItem(TODOS_KEY, JSON.stringify(todoData));
      updateHomeSummary();
      renderCalendar();
      renderCalendarSelectedTasks(selectedCalendarDateStr);
    }

    function cycleStatus(status) {
      if (status === "") return "success";
      if (status === "success") return "partial";
      if (status === "partial") return "fail";
      return "";
    }

    function getStatusSymbol(status) {
      if (todoStyle === "color-only") {
        return ""; // ìƒ‰ë§Œ ì‚¬ìš© ëª¨ë“œì—ì„œëŠ” ê¸°í˜¸ X
      }
      if (status === "success") return "â—‹";
      if (status === "partial") return "â–³";
      if (status === "fail") return "âœ•";
      return "â–¡";
    }

    function scopeLabel(scope) {
      if (scope === "year") return "1ë…„ ê³„íš";
      if (scope === "month") return "í•œ ë‹¬ ê³„íš";
      if (scope === "week") return "ì¼ì£¼ì¼ ê³„íš";
      if (scope === "day") return "í•˜ë£¨ ê³„íš";
      return scope;
    }

    function formatTodoDateForScope(scope, dateStr) {
      if (!dateStr) return "";
      const parts = dateStr.split("-");
      if (parts.length < 3) return dateStr;
      const y = parts[0];
      const m = parseInt(parts[1], 10);
      const d = parseInt(parts[2], 10);
      if (scope === "year") {
        return `${y}ë…„`;
      }
      if (scope === "month") {
        return `${y}ë…„ ${m}ì›”`;
      }
      if (scope === "week") {
        const weekIndex = Math.floor((d - 1) / 7) + 1;
        return `${y}ë…„ ${m}ì›” ${weekIndex}ì£¼ì°¨`;
      }
      return dateStr;
    }

    function renderTodoList() {
      const list = todoData[currentScope] || [];
      todoListEl.innerHTML = "";
      list.forEach((item, idx) => {
        const li = document.createElement("li");
        li.className = "todo-item";

        const left = document.createElement("div");
        left.className = "todo-left";

        const statusBtn = document.createElement("button");
        statusBtn.className = "status-btn";
        statusBtn.textContent = getStatusSymbol(item.status || "");
        statusBtn.classList.remove("success", "partial", "fail");
        // ê¸°ë³¸ ìŠ¤íƒ€ì¼ì€ CSSì— ë§¡ê¸°ê³ , ì—¬ê¸°ì„œëŠ” ì´ˆê¸°í™”ë§Œ
        statusBtn.style.backgroundColor = "";
        statusBtn.style.borderColor = "";
        statusBtn.style.color = "";

        if (item.status === "success") statusBtn.classList.add("success");
        if (item.status === "partial") statusBtn.classList.add("partial");
        if (item.status === "fail") statusBtn.classList.add("fail");

        if (todoStyle === "color-only") {
          // ìƒ‰ë§Œ ì‚¬ìš© ëª¨ë“œì—ì„œëŠ” ë„¤ëª¨ì¹¸ì„ ìƒ‰ìœ¼ë¡œ ì±„ìš°ê¸°
          if (item.status === "success") {
            statusBtn.style.backgroundColor = "var(--success)";
            statusBtn.style.borderColor = "var(--success)";
            statusBtn.style.color = "#0b1120";
          } else if (item.status === "partial") {
            statusBtn.style.backgroundColor = "var(--warning)";
            statusBtn.style.borderColor = "var(--warning)";
            statusBtn.style.color = "#0b1120";
          } else if (item.status === "fail") {
            statusBtn.style.backgroundColor = "var(--danger)";
            statusBtn.style.borderColor = "var(--danger)";
            statusBtn.style.color = "#0b1120";
          } else {
            statusBtn.style.backgroundColor = "rgba(148,163,184,0.6)";
            statusBtn.style.borderColor = "rgba(148,163,184,0.8)";
            statusBtn.style.color = "#0b1120";
          }
        }

        statusBtn.addEventListener("click", () => {
          const next = cycleStatus(item.status || "");
          item.status = next;
          saveTodos();
          renderTodoList();
        });

        const textWrap = document.createElement("div");
        const text = document.createElement("div");
        text.className = "todo-text";
        text.textContent = item.text;
        textWrap.appendChild(text);

        if (item.date) {
          const meta = document.createElement("div");
          meta.className = "todo-meta";
          const displayDate = formatTodoDateForScope(currentScope, item.date);
          meta.textContent = displayDate || item.date;
          textWrap.appendChild(meta);
        }

        left.appendChild(statusBtn);
        left.appendChild(textWrap);

        const actions = document.createElement("div");
        actions.className = "todo-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "tiny";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", () => {
          const newText = prompt("í•  ì¼ì„ ìˆ˜ì •í•˜ì„¸ìš”", item.text);
          if (newText && newText.trim()) {
            item.text = newText.trim();
            saveTodos();
            renderTodoList();
          }
        });

        const delBtn = document.createElement("button");
        delBtn.className = "tiny";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", () => {
          todoData[currentScope].splice(idx, 1);
          saveTodos();
          renderTodoList();
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        li.appendChild(left);
        li.appendChild(actions);
        todoListEl.appendChild(li);
      });
    }

    function addTodo() {
      const text = todoInput.value.trim();
      if (!text) return;

      let dateStr = null;
      if (currentScope === "year") {
        const y = todoYearSelect.value;
        dateStr = `${y}-01-01`;
      } else if (currentScope === "month") {
        const y = todoYearSelect.value;
        const m = String(todoMonthSelect.value).padStart(2, "0");
        dateStr = `${y}-${m}-01`;
      } else if (currentScope === "week") {
        const y = parseInt(todoYearSelect.value, 10);
        const mIndex = parseInt(todoMonthSelect.value, 10) - 1;
        const w = parseInt(todoWeekSelect.value, 10);
        const baseDate = new Date(y, mIndex, 1 + (w - 1) * 7);
        dateStr = formatDate(baseDate);
      } else if (currentScope === "day") {
        dateStr = todoDateInput.value || null;
      }

      todoData[currentScope].push({ text, status: "", date: dateStr });
      todoInput.value = "";
      if (currentScope === "day") {
        todoDateInput.value = "";
      }

      saveTodos();
      renderTodoList();
    }

    scopeTabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        scopeTabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        currentScope = tab.dataset.scope;
        updateTodoDateInputs();
        renderTodoList();
      });
    });

    todoAddBtn.addEventListener("click", addTodo);
    todoInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addTodo();
    });

    loadTodos();
    updateTodoDateInputs();
    renderTodoList();
    setupSearch("todo-search", "todo-list");

    // ===== ì£¼ê°„ ì‹œê°„í‘œ (ì‹œê°„ ë‹¨ìœ„) =====
    const TIMETABLE_KEY = "study_os_timetable_v1";
    const timetableGridEl = document.getElementById("timetable-grid");
    const timetableDays = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"];

    // 0ì‹œ~23ì‹œë¥¼ ìˆ«ìë¡œ ì €ì¥
    const timetableTimes = [];
    for (let h = 0; h <= 23; h++) {
      timetableTimes.push(h);
    }

    // ì‹œê°„í‘œ ë¼ë²¨ í¬ë§· í•¨ìˆ˜
    function formatHourLabel(h) {
      return `${String(h).padStart(2, "0")}:00`;
    }

    let timetableData = {};

    function loadTimetable() {
      try {
        const saved = localStorage.getItem(TIMETABLE_KEY);
        timetableData = saved ? JSON.parse(saved) : {};
      } catch {
        timetableData = {};
      }
    }

    function saveTimetable() {
      localStorage.setItem(TIMETABLE_KEY, JSON.stringify(timetableData));
    }

    function renderTimetable() {
      if (!timetableGridEl) return;
      timetableGridEl.innerHTML = "";

      const emptyHeader = document.createElement("div");
      emptyHeader.className = "timetable-header";
      emptyHeader.textContent = "ì‹œê°„";
      timetableGridEl.appendChild(emptyHeader);

      timetableDays.forEach((day) => {
        const h = document.createElement("div");
        h.className = "timetable-header";
        h.textContent = day;
        timetableGridEl.appendChild(h);
      });

      timetableTimes.forEach((hour, timeIndex) => {
        const rowLabel = document.createElement("div");
        rowLabel.className = "timetable-header";
        rowLabel.textContent = formatHourLabel(hour);
        timetableGridEl.appendChild(rowLabel);

        timetableDays.forEach((_, dayIndex) => {
          const cell = document.createElement("div");
          cell.className = "timetable-cell";
          cell.contentEditable = "true";
          const key = `${timeIndex}_${dayIndex}`;

          if (timetableData[key]) {
            cell.textContent = timetableData[key];
          }

          cell.addEventListener("input", () => {
            const text = cell.textContent.trim();
            if (text) {
              timetableData[key] = text;
            } else {
              delete timetableData[key];
            }
            saveTimetable();
          });

          timetableGridEl.appendChild(cell);
        });
      });
    }

    loadTimetable();
    renderTimetable();

    // ===== ìº˜ë¦°ë” =====
    const calendarGrid = document.getElementById("calendar-grid");
    const calendarMonthLabel = document.getElementById("calendar-month-label");
    const calendarPrevBtn = document.getElementById("calendar-prev-btn");
    const calendarNextBtn = document.getElementById("calendar-next-btn");
    const calendarSelectedDateEl = document.getElementById("calendar-selected-date");
    const calendarTaskList = document.getElementById("calendar-task-list");
    const calendarAddTodoBtn = document.getElementById("calendar-add-todo-btn");
    const calendarMonthPicker = document.getElementById("calendar-month-picker");
    let calendarCurrent = new Date(today.getFullYear(), today.getMonth(), 1);
    let selectedCalendarDateStr = formatDate(today);

    if (calendarAddTodoBtn) {
      calendarAddTodoBtn.addEventListener("click", () => {
        const todosNavBtn = document.querySelector('.nav-btn[data-section="todos"]');
        if (todosNavBtn) todosNavBtn.click();
        currentScope = "day";
        scopeTabs.forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.scope === "day");
        });
        if (todoDateInput) {
          todoDateInput.value = selectedCalendarDateStr;
          todoDateInput.focus();
        }
        updateTodoDateInputs();
        renderTodoList();
      });
    }

    function getTodosByDate(dateStr) {
      const result = [];
      ["year", "month", "week", "day"].forEach((scope) => {
        (todoData[scope] || []).forEach((item) => {
          if (item.date === dateStr) {
            result.push({ ...item, scope });
          }
        });
      });
      return result;
    }

    function getDDaysByDate(dateStr) {
      return ddayItems.filter((d) => d.date === dateStr);
    }

    function renderCalendar() {
      const year = calendarCurrent.getFullYear();
      const month = calendarCurrent.getMonth();
      calendarMonthLabel.textContent = `${year}ë…„ ${month + 1}ì›”`;

      if (calendarMonthPicker) {
        const monthValue = `${year}-${String(month + 1).padStart(2, "0")}`;
        if (calendarMonthPicker.value !== monthValue) {
          calendarMonthPicker.value = monthValue;
        }
      }

      calendarGrid.innerHTML = "";

      const weekdays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
      weekdays.forEach((wd) => {
        const div = document.createElement("div");
        div.className = "calendar-weekday";
        div.textContent = wd;
        calendarGrid.appendChild(div);
      });

      const firstDay = new Date(year, month, 1);
      const startDayOfWeek = firstDay.getDay();

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const prevMonthDays = new Date(year, month, 0).getDate();

      const totalCells = 42;
      const todayStr = formatDate(today);

      for (let i = 0; i < totalCells; i++) {
        const cellIndex = i - startDayOfWeek + 1;
        let cellDate, inCurrentMonth = true;

        if (cellIndex <= 0) {
          cellDate = new Date(year, month - 1, prevMonthDays + cellIndex);
          inCurrentMonth = false;
        } else if (cellIndex > daysInMonth) {
          cellDate = new Date(year, month + 1, cellIndex - daysInMonth);
          inCurrentMonth = false;
        } else {
          cellDate = new Date(year, month, cellIndex);
        }

        const dateStr = formatDate(cellDate);
        const dayDiv = document.createElement("div");
        dayDiv.className = "calendar-day";
        if (!inCurrentMonth) {
          dayDiv.classList.add("other-month");
        }
        if (dateStr === selectedCalendarDateStr) {
          dayDiv.classList.add("selected");
        }

        const numDiv = document.createElement("div");
        numDiv.className = "calendar-day-number";
        numDiv.textContent = cellDate.getDate();

        dayDiv.appendChild(numDiv);

        const todosForDay = getTodosByDate(dateStr);
        const ddaysForDay = getDDaysByDate(dateStr);
        if (todosForDay.length > 0 || ddaysForDay.length > 0) {
          const dot = document.createElement("div");
          dot.className = "calendar-day-dot";
          dayDiv.appendChild(dot);
        } else {
          const spacer = document.createElement("div");
          spacer.style.height = "6px";
          dayDiv.appendChild(spacer);
        }

        if (dateStr === todayStr) {
          dayDiv.style.boxShadow = "0 0 0 1px rgba(148,163,184,0.5)";
        }

        dayDiv.addEventListener("click", () => {
          selectedCalendarDateStr = dateStr;
          renderCalendar();
          renderCalendarSelectedTasks(selectedCalendarDateStr);
        });

        calendarGrid.appendChild(dayDiv);
      }
    }

    function renderCalendarSelectedTasks(dateStr) {
    calendarSelectedDateEl.textContent = `ì„ íƒí•œ ë‚ ì§œ: ${dateStr}`;
    calendarTaskList.innerHTML = "";

    // â˜… ë¨¼ì € ê³µë¶€ ì‹œê°„ ìš”ì•½ ë³´ì—¬ì£¼ê¸°
    const studySec = getStudySecondsForDate(dateStr);
    const studyBox = document.createElement("div");
    studyBox.style.margin = "4px 0 6px";
    studyBox.style.padding = "6px 8px";
    studyBox.style.borderRadius = "10px";
    studyBox.style.border = "1px solid rgba(148,163,184,0.45)";
    studyBox.style.fontSize = "0.8rem";

    if (studySec > 0) {
      studyBox.textContent = `ì´ ë‚ ì˜ ì´ ê³µë¶€ ì‹œê°„: ${formatHMS(studySec)}`;
    } else {
      studyBox.textContent = "ì´ ë‚ ì—ëŠ” ê¸°ë¡ëœ ê³µë¶€ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.";
    }
    calendarTaskList.appendChild(studyBox);

    const todosForDay = getTodosByDate(dateStr);
    const ddaysForDay = getDDaysByDate(dateStr);

      if (ddaysForDay.length === 0 && todosForDay.length === 0) {
        const p = document.createElement("div");
        p.textContent = "ì´ ë‚ ì§œì—ëŠ” ë“±ë¡ëœ D-Dayë‚˜ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.";
        p.style.color = "var(--text-muted)";
        p.style.fontSize = "0.8rem";
        calendarTaskList.appendChild(p);
        return;
      }

      if (ddaysForDay.length > 0) {
        const title = document.createElement("div");
        title.textContent = "D-Day";
        title.style.fontSize = "0.78rem";
        title.style.fontWeight = "600";
        title.style.margin = "4px 0 2px";
        calendarTaskList.appendChild(title);

        ddaysForDay.forEach((d) => {
          const div = document.createElement("div");
          div.className = "calendar-task-item";
          const main = document.createElement("div");
          const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const diff = Math.round(
            (new Date(d.date).setHours(0,0,0,0) - todayOnly.getTime()) /
            (1000*60*60*24)
          );
          let tag = "";
          if (diff > 0) tag = `D-${diff}`;
          else if (diff === 0) tag = "D-DAY";
          else tag = `D+${Math.abs(diff)}`;
          main.textContent = `${tag} Â· ${d.title}`;
          const sub = document.createElement("div");
          sub.className = "calendar-task-scope";
          sub.textContent = d.date;
          div.appendChild(main);
          div.appendChild(sub);
          calendarTaskList.appendChild(div);
        });
      }

      if (todosForDay.length > 0) {
        const title = document.createElement("div");
        title.textContent = "ê³„íš / í•  ì¼";
        title.style.fontSize = "0.78rem";
        title.style.fontWeight = "600";
        title.style.margin = "6px 0 2px";
        calendarTaskList.appendChild(title);

        todosForDay.forEach((item) => {
          const div = document.createElement("div");
          div.className = "calendar-task-item";
          const main = document.createElement("div");
          main.textContent = `${getStatusSymbol(item.status || "")} ${item.text}`;
          const scopeInfo = document.createElement("div");
          scopeInfo.className = "calendar-task-scope";
          scopeInfo.textContent = scopeLabel(item.scope);
          div.appendChild(main);
          div.appendChild(scopeInfo);
          calendarTaskList.appendChild(div);
        });
      }
    }

    calendarPrevBtn.addEventListener("click", () => {
      calendarCurrent = new Date(
        calendarCurrent.getFullYear(),
        calendarCurrent.getMonth() - 1,
        1
      );
      renderCalendar();
      renderCalendarSelectedTasks(selectedCalendarDateStr);
    });

    calendarNextBtn.addEventListener("click", () => {
      calendarCurrent = new Date(
        calendarCurrent.getFullYear(),
        calendarCurrent.getMonth() + 1,
        1
      );
      renderCalendar();
      renderCalendarSelectedTasks(selectedCalendarDateStr);
    });

    if (calendarMonthPicker) {
      calendarMonthPicker.addEventListener("change", (e) => {
        if (!e.target.value) return;
        const [y, m] = e.target.value.split("-");
        calendarCurrent = new Date(Number(y), Number(m) - 1, 1);
        renderCalendar();
        renderCalendarSelectedTasks(selectedCalendarDateStr);
      });
    }

    renderCalendar();

    // ===== í¬ëª¨ë„ë¡œ =====
    const POMO_CONFIG_KEY = "study_os_pomo_config_v1";

    const pomoDisplay = document.getElementById("pomo-display");
    const pomoPhaseEl = document.getElementById("pomo-phase");
    const pomoProgressText = document.getElementById("pomo-progress-text");
    const pomoStartBtn = document.getElementById("pomo-start-btn");
    const pomoPauseBtn = document.getElementById("pomo-pause-btn");
    const pomoResetBtn = document.getElementById("pomo-reset-btn");

    const pomoFocusMinInput = document.getElementById("pomo-focus-min");
    const pomoShortMinInput = document.getElementById("pomo-short-min");
    const pomoLongMinInput = document.getElementById("pomo-long-min");
    const pomoCyclesInput = document.getElementById("pomo-cycles");
    const pomoSaveConfigBtn = document.getElementById("pomo-save-config-btn");

    let pomoConfig = {
      focus: 25,
      shortBreak: 5,
      longBreak: 10,
      cyclesBeforeLong: 4,
    };

    function loadPomoConfig() {
      try {
        const saved = localStorage.getItem(POMO_CONFIG_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          pomoConfig = Object.assign(pomoConfig, parsed);
        }
      } catch {
        // ignore
      }
      pomoFocusMinInput.value = pomoConfig.focus;
      pomoShortMinInput.value = pomoConfig.shortBreak;
      pomoLongMinInput.value = pomoConfig.longBreak;
      pomoCyclesInput.value = pomoConfig.cyclesBeforeLong;
    }

    function savePomoConfig() {
      pomoConfig.focus = Math.max(
        1,
        parseInt(pomoFocusMinInput.value || "25", 10)
      );
      pomoConfig.shortBreak = Math.max(
        1,
        parseInt(pomoShortMinInput.value || "5", 10)
      );
      pomoConfig.longBreak = Math.max(
        1,
        parseInt(pomoLongMinInput.value || "10", 10)
      );
      pomoConfig.cyclesBeforeLong = Math.max(
        1,
        parseInt(pomoCyclesInput.value || "4", 10)
      );
      localStorage.setItem(POMO_CONFIG_KEY, JSON.stringify(pomoConfig));
      if (!pomoRunning) {
        pomoSecondsLeft = pomoConfig.focus * 60;
        updatePomoDisplay();
      }
    }

    pomoSaveConfigBtn.addEventListener("click", () => {
      savePomoConfig();
      alert("í¬ëª¨ë„ë¡œ ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
    });

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    let pomoMode = "idle"; // idle | focus | short | long
    let pomoCycleCount = 0;
    let pomoSecondsLeft = pomoConfig.focus * 60;
    let pomoIntervalId = null;
    let pomoRunning = false;

    function updatePomoDisplay() {
      pomoDisplay.textContent = formatTime(pomoSecondsLeft);
      let phaseText = "";
      if (pomoMode === "focus") phaseText = "ì§‘ì¤‘ ì‹œê°„";
      else if (pomoMode === "short") phaseText = "ì§§ì€ íœ´ì‹";
      else if (pomoMode === "long") phaseText = "ê¸´ íœ´ì‹";
      else phaseText = "ëŒ€ê¸° ì¤‘";
      pomoPhaseEl.textContent = phaseText;
      pomoProgressText.textContent = `${pomoCycleCount} / ${pomoConfig.cyclesBeforeLong} ì‚¬ì´í´`;
    }

    function startPomoTicking() {
      if (pomoIntervalId !== null) return;
      pomoRunning = true;
      requestWakeLock();
      pomoIntervalId = setInterval(() => {
        pomoSecondsLeft--;
        if (pomoSecondsLeft <= 0) {
          handlePomoPhaseEnd();
        }
        updatePomoDisplay();
      }, 1000);
    }

    function stopPomoTicking() {
      if (pomoIntervalId !== null) {
        clearInterval(pomoIntervalId);
        pomoIntervalId = null;
      }
      pomoRunning = false;
      releaseWakeLockIfNeeded();
    }

    function handlePomoPhaseEnd() {
      if (pomoMode === "focus") {
        if (pomoCycleCount >= pomoConfig.cyclesBeforeLong) {
          pomoMode = "long";
          pomoSecondsLeft = pomoConfig.longBreak * 60;
          const title = "My Study OS - í¬ëª¨ë„ë¡œ";
          const body  = "ì§‘ì¤‘ ì„¸íŠ¸ ì™„ë£Œ! ê¸´ íœ´ì‹ì„ ê°€ì ¸ë³´ì„¸ìš”.";

          alert(body);
          showLocalNotification(title, body);
          if (typeof window.sendPushViaWorker === "function") {
            window.sendPushViaWorker(title, body);
          }
        } else {
          pomoMode = "short";
          pomoSecondsLeft = pomoConfig.shortBreak * 60;
          const title = "My Study OS - í¬ëª¨ë„ë¡œ";
          const body  = "ì§‘ì¤‘ ë! ì§§ì€ íœ´ì‹ì„ ê°€ì ¸ë³´ì„¸ìš”.";

          alert(body);
          showLocalNotification(title, body);
          if (typeof window.sendPushViaWorker === "function") {
            window.sendPushViaWorker(title, body);
          }
        }
      } else if (pomoMode === "short") {
        pomoCycleCount++;
        if (pomoCycleCount >= pomoConfig.cyclesBeforeLong) {
          pomoMode = "long";
          pomoSecondsLeft = pomoConfig.longBreak * 60;
          const title = "My Study OS - í¬ëª¨ë„ë¡œ";
          const body  = "ì—¬ëŸ¬ ë²ˆì˜ ì§‘ì¤‘ì„ ë§ˆì³¤ì–´ìš”. ê¸´ íœ´ì‹ì„ ê°€ì ¸ë³´ì„¸ìš”!";

          alert(body);
          showLocalNotification(title, body);
          if (typeof window.sendPushViaWorker === "function") {
            window.sendPushViaWorker(title, body);
          }
        } else {
          pomoMode = "focus";
          pomoSecondsLeft = pomoConfig.focus * 60;
          const title = "My Study OS - í¬ëª¨ë„ë¡œ";
          const body  = "íœ´ì‹ ë! ë‹¤ì‹œ ì§‘ì¤‘ ì‹œì‘!";

          alert(body);
          showLocalNotification(title, body);
          if (typeof window.sendPushViaWorker === "function") {
            window.sendPushViaWorker(title, body);
          }
        }
      } else if (pomoMode === "long") {
        const title = "My Study OS - í¬ëª¨ë„ë¡œ";
        const body  = "ê¸´ íœ´ì‹ê¹Œì§€ ëª¨ë‘ ëë‚¬ì–´ìš”. ìˆ˜ê³ í–ˆì–´ìš”!";

        alert("ê¸´ íœ´ì‹ê¹Œì§€ ëª¨ë‘ ëë‚¬ì–´ìš”. ìˆ˜ê³ í–ˆì–´ìš”! ë‹¤ì‹œ ì‹œì‘í• ì§€ ê²°ì •í•´ ë³´ì„¸ìš”.");
        showLocalNotification(title, body);
        if (typeof window.sendPushViaWorker === "function") {
          window.sendPushViaWorker(title, body);
        }

        pomoMode = "idle";
        pomoCycleCount = 0;
        pomoSecondsLeft = pomoConfig.focus * 60;
        stopPomoTicking();
      }
      updatePomoDisplay();
    }

    pomoStartBtn.addEventListener("click", () => {
      if (pomoMode === "idle") {
        pomoMode = "focus";
        pomoCycleCount = 0;
        pomoSecondsLeft = pomoConfig.focus * 60;
        updatePomoDisplay();
      }
      startPomoTicking();
      openFocusOverlay("pomo");
    });

    pomoPauseBtn.addEventListener("click", () => {
      if (!pomoRunning) return;
      stopPomoTicking();
      pomoPhaseEl.textContent += " (ì¼ì‹œ ì •ì§€)";
    });

    pomoResetBtn.addEventListener("click", () => {
      if (!confirm("í¬ëª¨ë„ë¡œ íƒ€ì´ë¨¸ë¥¼ ë¦¬ì…‹í• ê¹Œìš”?")) return;
      stopPomoTicking();
      pomoMode = "idle";
      pomoCycleCount = 0;
      pomoSecondsLeft = pomoConfig.focus * 60;
      updatePomoDisplay();
      if (focusMode === "pomo") {
        closeFocusOverlay();
      }
    });

    loadPomoConfig();
    pomoSecondsLeft = pomoConfig.focus * 60;
    updatePomoDisplay();

    // ===== ê³µë¶€ íƒ€ì´ë¨¸ =====
    const STUDY_KEY = "study_os_study_log_v1";
    const STUDY_SESSION_KEY = "study_os_current_session";

    const studyTimeTodayEl = document.getElementById("study-time-today");
    const studyStatusEl = document.getElementById("study-status");
    const studyStartBtn = document.getElementById("study-start-btn");
    const studyStopBtn = document.getElementById("study-stop-btn");
    const studyResetBtn = document.getElementById("study-reset-btn");
    const studyFocusBtn = document.getElementById("study-focus-btn");
    const studySessionTimeEl = document.getElementById("study-session-time");
    const studyLastSessionEl = document.getElementById("study-last-session");

    let studyRunning = false;
    let studySessionStart = null;
    let studySessionTimerId = null;
    let studyLastSessionSeconds = null;

    function loadStudyLog() {
      try {
        const saved = localStorage.getItem(STUDY_KEY);
        studyLog = saved ? JSON.parse(saved) : {};
      } catch {
        studyLog = {};
      }
      try {
        const savedSession = localStorage.getItem(STUDY_SESSION_KEY);
        if (savedSession) {
          const obj = JSON.parse(savedSession);
          if (obj.running && obj.startTime) {
            studySessionStart = new Date(obj.startTime);
            studyRunning = true;
            startStudySessionTicking();
            studyStatusEl.textContent = "ê³µë¶€ ì¤‘ (ì´ì „ì— ì‹œì‘ë¨)";
            requestWakeLock();
          }
        }
      } catch {
        // ignore
      }
    }

    function saveStudyLog() {
      localStorage.setItem(STUDY_KEY, JSON.stringify(studyLog));
      updateStudyDisplay();
      updateHomeSummary();
    }

    function saveStudySessionState() {
      localStorage.setItem(
        STUDY_SESSION_KEY,
        JSON.stringify({
          running: studyRunning,
          startTime: studySessionStart ? studySessionStart.toISOString() : null,
        })
      );
    }

    function formatHMS(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return (
        String(h).padStart(2, "0") +
        ":" +
        String(m).padStart(2, "0") +
        ":" +
        String(s).padStart(2, "0")
      );
    }

    function getTodaySeconds() {
      const key = formatDate(today);
      return studyLog[key] || 0;
    }

    function getStudySecondsForDate(dateStr) {
      if (!studyLog) return 0;
      return studyLog[dateStr] || 0;
    }

    function updateStudyDisplay() {
      const total = getTodaySeconds();
      studyTimeTodayEl.textContent = formatHMS(total);
      if (studyLastSessionSeconds != null) {
        studyLastSessionEl.textContent = formatHMS(studyLastSessionSeconds);
      }
    }

    function updateStudySessionTime() {
      if (!studySessionStart) {
        studySessionTimeEl.textContent = "00:00:00";
        return;
      }
      const diffSec = Math.max(
        0,
        Math.floor((Date.now() - studySessionStart.getTime()) / 1000)
      );
      studySessionTimeEl.textContent = formatHMS(diffSec);
    }

    function startStudySessionTicking() {
      if (studySessionTimerId !== null) return;
      studySessionTimerId = setInterval(updateStudySessionTime, 1000);
      requestWakeLock();
    }

    function stopStudySessionTicking() {
      if (studySessionTimerId !== null) {
        clearInterval(studySessionTimerId);
        studySessionTimerId = null;
      }
      releaseWakeLockIfNeeded();
    }

    function finishStudySession() {
      if (!studyRunning || !studySessionStart) return;
      const now = new Date();
      const diffSec = Math.max(
        0,
        Math.floor((now.getTime() - studySessionStart.getTime()) / 1000)
      );
      studyLastSessionSeconds = diffSec;
      const key = formatDate(today);
      studyLog[key] = (studyLog[key] || 0) + diffSec;
      studyRunning = false;
      studySessionStart = null;
      studyStatusEl.textContent = "ëŒ€ê¸° ì¤‘";
      stopStudySessionTicking();
      saveStudySessionState();
      saveStudyLog();
      updateStudySessionTime();
    }

    studyStartBtn.addEventListener("click", () => {
      if (studyRunning) return;
      studyRunning = true;
      studySessionStart = new Date();
      studyStatusEl.textContent = "ê³µë¶€ ì¤‘";
      saveStudySessionState();
      startStudySessionTicking();
      openFocusOverlay("study");
    });

    studyStopBtn.addEventListener("click", () => {
      finishStudySession();
      if (focusMode === "study") {
        closeFocusOverlay();
      }
    });

    studyResetBtn.addEventListener("click", () => {
      if (!confirm("ì˜¤ëŠ˜ ê³µë¶€ ì‹œê°„ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      const key = formatDate(today);
      studyLog[key] = 0;
      studyLastSessionSeconds = null;
      studyRunning = false;
      studySessionStart = null;
      stopStudySessionTicking();
      saveStudySessionState();
      saveStudyLog();
      studyStatusEl.textContent = "ëŒ€ê¸° ì¤‘";
      studySessionTimeEl.textContent = "00:00:00";
      studyLastSessionEl.textContent = "-";
    });

    if (studyFocusBtn) {
      studyFocusBtn.addEventListener("click", () => {
        openFocusOverlay("study");
      });
    }

    loadStudyLog();
    updateStudyDisplay();
    updateStudySessionTime();
    renderCalendarSelectedTasks(selectedCalendarDateStr);

    // ===== ë¶„ëŸ‰ ê³„ì‚°ê¸° (ë¬¸ì œ/í˜ì´ì§€) =====
    const planUnitSelect = document.getElementById("plan-unit");
    const planTotalInput = document.getElementById("plan-total");
    const planDeadlineInput = document.getElementById("plan-deadline");
    const planWeeklyCountInput = document.getElementById("plan-weekly-count");
    const planCalcBtn = document.getElementById("plan-calc-btn");
    const planResultEl = document.getElementById("plan-result");

    function calculatePlanPerSession() {
      if (!planResultEl) return;

      const mode = planUnitSelect.value; // "problem" or "page"
      const unitLabel = mode === "problem" ? "ë¬¸ì œ" : "í˜ì´ì§€";

      const total = Number(planTotalInput.value);
      const weekly = Number(planWeeklyCountInput.value);
      const deadlineStr = planDeadlineInput.value;

      if (!total || total <= 0 || !weekly || weekly <= 0 || !deadlineStr) {
        planResultEl.textContent = "ì´ ë¶„ëŸ‰, ë§ˆê°ì¼, ì£¼ë‹¹ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
        return;
      }

      // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë‚¨ì€ ê¸°ê°„ ê³„ì‚°
      const today = new Date();
      const todayStr = formatDate(today); // "YYYY-MM-DD"
      const start = new Date(todayStr);
      const end = new Date(deadlineStr);

      // ì‹œ/ë¶„/ì´ˆ ì œê±°í•´ì„œ ë‚ ì§œë§Œ ë¹„êµ
      const startOnly = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const endOnly = new Date(end.getFullYear(), end.getMonth(), end.getDate());

      const diffMs = endOnly - startOnly;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)); // ë‚¨ì€ â€˜ì¼â€™ ìˆ˜

      if (diffDays < 0) {
        planResultEl.textContent = "ë§ˆê°ì¼ì´ ì´ë¯¸ ì§€ë‚¬ì–´ìš”. ë§ˆê°ì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.";
        return;
      }

      const daysInclusive = diffDays + 1; // ì˜¤ëŠ˜ í¬í•¨
      const weeks = daysInclusive / 7;
      const approxWeeks = weeks.toFixed(1);

      // ì „ì²´ ê³µë¶€ ì„¸ì…˜ íšŸìˆ˜ = (ì£¼ ìˆ˜) Ã— (ì£¼ë‹¹ íšŸìˆ˜)
      const rawSessions = weeks * weekly;
      const totalSessions = Math.max(1, Math.ceil(rawSessions));

      // 1íšŒë‹¹ í•´ì•¼ í•  ë¶„ëŸ‰
      const perSession = Math.ceil(total / totalSessions);

      planResultEl.innerHTML =
        `ğŸ“Œ ì´ ${total}${unitLabel}ë¥¼ ${deadlineStr}ê¹Œì§€ ë§ˆì¹˜ë ¤ë©´<br>` +
        `Â· ë‚¨ì€ ê¸°ê°„: ì•½ ${daysInclusive}ì¼ (â‰ˆ ${approxWeeks}ì£¼)<br>` +
        `Â· ì „ì²´ íšŸìˆ˜: ì£¼ ${weekly}íšŒ ê¸°ì¤€, ì´ ì•½ ${totalSessions}íšŒ<br>` +
        `âœ… 1íšŒì— <strong>${perSession}${unitLabel}</strong>ì”© í•˜ë©´ ë¼ìš”.`;
    }

    if (planCalcBtn) {
      planCalcBtn.addEventListener("click", calculatePlanPerSession);

      // Enterë¡œë„ ê³„ì‚°í•  ìˆ˜ ìˆê²Œ
      planTotalInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") calculatePlanPerSession();
      });
      planWeeklyCountInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") calculatePlanPerSession();
      });
      planDeadlineInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") calculatePlanPerSession();
      });
    }
    
    // ===== ì§‘ì¤‘ ëª¨ë“œ =====
    const focusOverlay = document.getElementById("focus-overlay");
    const focusExitBtn = document.getElementById("focus-exit-btn");
    const focusTimerLabel = document.getElementById("focus-timer-label");
    const focusTitleEl = document.getElementById("focus-title");
    const focusSubtitleEl = document.getElementById("focus-subtitle");
    const focusExtraInfoEl = document.getElementById("focus-extra-info");

    let focusIntervalId = null;
    let focusStartTime = null;
    let focusMode = "generic"; // 'study' | 'pomo' | 'generic'

    function openFocusOverlay(mode = "generic") {
      focusMode = mode;
      focusOverlay.style.display = "flex";
      focusStartTime = new Date();

      if (mode === "study") {
        focusTitleEl.textContent = "ê³µë¶€ ì§‘ì¤‘ ëª¨ë“œ";
        focusSubtitleEl.innerHTML = "í˜„ì¬ ê³µë¶€ ì„¸ì…˜ ì‹œê°„ê³¼<br/>ì˜¤ëŠ˜ ì´ ê³µë¶€ ì‹œê°„ì„ ë³´ë©´ì„œ ì§‘ì¤‘í•´ë´ìš”.";
      } else if (mode === "pomo") {
        focusTitleEl.textContent = "í¬ëª¨ë„ë¡œ ì§‘ì¤‘ ëª¨ë“œ";
        focusSubtitleEl.innerHTML = "ì´ë²ˆ í¬ëª¨ë„ë¡œê°€ ëª‡ ë²ˆì§¸ì¸ì§€ì™€<br/>ë‚¨ì€ ì‹œê°„ì„ í™•ì¸í•˜ë©´ì„œ ì§‘ì¤‘í•´ë´ìš”.";
      } else {
        focusTitleEl.textContent = "ì§€ê¸ˆì€ ì§‘ì¤‘ ëª¨ë“œ";
        focusSubtitleEl.innerHTML = "ì´ ì‹œê°„ë§Œí¼ì€ ë‹¤ë¥¸ ì•±/ì‚¬ì´íŠ¸ ìƒê° ë§ê³ ,<br />ëˆˆì•ì˜ ê³µë¶€ì—ë§Œ ì§‘ì¤‘í•´ë´ìš”.";
      }

      updateFocusTimer();
      if (focusIntervalId !== null) clearInterval(focusIntervalId);
      focusIntervalId = setInterval(updateFocusTimer, 1000);
    }

    function closeFocusOverlay() {
      focusOverlay.style.display = "none";
      if (focusIntervalId !== null) {
        clearInterval(focusIntervalId);
        focusIntervalId = null;
      }
      focusMode = "generic";
      focusExtraInfoEl.textContent = "";
    }

    function updateFocusTimer() {
      if (focusMode === "study") {
        if (!studySessionStart) {
          focusTimerLabel.textContent = "00:00:00";
          focusExtraInfoEl.textContent = "ê³µë¶€ íƒ€ì´ë¨¸ê°€ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.";
          return;
        }
        const diffSec = Math.max(
          0,
          Math.floor((Date.now() - studySessionStart.getTime()) / 1000)
        );
        const current = formatHMS(diffSec);
        const total = getTodaySeconds() + diffSec;
        focusTimerLabel.textContent = current;
        focusExtraInfoEl.textContent = `ì˜¤ëŠ˜ ì´ ê³µë¶€ ì‹œê°„: ${formatHMS(total)}`;
      } else if (focusMode === "pomo") {
        focusTimerLabel.textContent = formatTime(pomoSecondsLeft);
        let currentCycle = pomoMode === "focus" ? pomoCycleCount + 1 : pomoCycleCount;
        if (currentCycle < 1) currentCycle = 1;
        const phaseText = pomoPhaseEl.textContent || "";
        focusExtraInfoEl.textContent = `ì˜¤ëŠ˜ì˜ í¬ëª¨ë„ë¡œ ${currentCycle}ë²ˆì§¸ Â· ${phaseText}`;
      } else {
        if (!focusStartTime) {
          focusTimerLabel.textContent = "--:--";
          focusExtraInfoEl.textContent = "";
          return;
        }
        const diffSec = Math.floor(
          (Date.now() - focusStartTime.getTime()) / 1000
        );
        const m = Math.floor(diffSec / 60);
        const s = diffSec % 60;
        focusTimerLabel.textContent =
          String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
        focusExtraInfoEl.textContent = "";
      }
    }

    focusExitBtn.addEventListener("click", () => {
      // ê³µë¶€ íƒ€ì´ë¨¸: ì„¸ì…˜ ì¢…ë£Œ + ê¸°ë¡
      if (focusMode === "study" && studyRunning) {
        finishStudySession();
      }
      // í¬ëª¨ë„ë¡œ: íƒ€ì´ë¨¸ë§Œ ì¼ì‹œì •ì§€ (ë¦¬ì…‹ X)
      if (focusMode === "pomo" && pomoRunning) {
        stopPomoTicking();
        pomoPhaseEl.textContent += " (ì¼ì‹œ ì •ì§€)";
      }
      closeFocusOverlay();
    });

    // ===== Wake Lock =====
    let wakeLock = null;
    let wakeLockRequested = false;

    async function requestWakeLock() {
      if (!("wakeLock" in navigator)) return;
      if (wakeLockRequested) return;
      try {
        wakeLockRequested = true;
        wakeLock = await navigator.wakeLock.request("screen");
        wakeLock.addEventListener("release", () => {
          wakeLockRequested = false;
        });
      } catch (e) {
        wakeLockRequested = false;
      }
    }

    function releaseWakeLockIfNeeded() {
      const anyTimerRunning = pomoRunning || studyRunning;
      if (!anyTimerRunning && wakeLock) {
        wakeLock.release();
        wakeLock = null;
        wakeLockRequested = false;
      }
    }

    // ===== í™ˆ ìš”ì•½ =====
    const summaryStudyTimeEl = document.getElementById("summary-study-time");
    const summaryDoneCountEl = document.getElementById("summary-done-count");

    function countAllDoneTodos() {
      let count = 0;
      ["year", "month", "week", "day"].forEach((scope) => {
        (todoData[scope] || []).forEach((item) => {
          if (item.status === "success") count++;
        });
      });
      return count;
    }

    function updateHomeSummary() {
      summaryStudyTimeEl.textContent = formatHMS(getTodaySeconds());
      summaryDoneCountEl.textContent = String(countAllDoneTodos());
    }

    updateHomeSummary();

    function checkDdayNotifications(now) {
      if (!ddayItems || !ddayItems.length) return;
      if (!ddayReminderTime) return;

      const todayStr = formatDate(now);

      // ì˜¤ëŠ˜ ì´ë¯¸ D-Day ì•Œë¦¼ì„ ë³´ëƒˆë‹¤ë©´ ë‹¤ì‹œ ë³´ë‚´ì§€ ì•ŠìŒ
      if (lastDdayNotifyDateStr === todayStr) return;

      const todayOnly = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate()
      );
      const todayMs = todayOnly.getTime();

      const [hh, mm] = ddayReminderTime.split(":");
      const targetH = Number(hh);
      const targetM = Number(mm);

      const hour = now.getHours();
      const minute = now.getMinutes();

      if (hour !== targetH || minute !== targetM) return;

      let hasTomorrowDday = false;

      ddayItems.forEach((item) => {
        const d = new Date(item.date);
        const dOnly = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const diffDays = Math.round((dOnly.getTime() - todayMs) / 86400000);

        if (diffDays === 1) {
          hasTomorrowDday = true;

          const title = "My Study OS - D-Day";
          const body  = `ë‚´ì¼ì€ "${item.title}" D-Day ì…ë‹ˆë‹¤!`;

          // ë¡œì»¬ ì•Œë¦¼
          showLocalNotification(title, body);
          // í‘¸ì‹œ ì•Œë¦¼ (Cloudflare Worker -> FCM)
          if (typeof window.sendPushViaWorker === "function") {
            window.sendPushViaWorker(title, body);
          }
        }
      });

      if (hasTomorrowDday) {
        lastDdayNotifyDateStr = todayStr;
        localStorage.setItem(LAST_DDAY_NOTIFY_KEY, todayStr);
      }
    }

    function checkStudyStartReminder(now) {
      if (!studyReminderTime) return;

      const [hh, mm] = studyReminderTime.split(":");
      const targetH = Number(hh);
      const targetM = Number(mm);

      const hour = now.getHours();
      const minute = now.getMinutes();
      const second = now.getSeconds();

      if (hour === targetH && minute === targetM && second === 0) {
        const title = "My Study OS - ê³µë¶€ ì‹œì‘";
        const body  = "ì •í•´ë‘” ê³µë¶€ ì‹œì‘ ì‹œê°„ì´ì˜ˆìš”. ì˜¤ëŠ˜ë„ í•œ ë²ˆ ë‹¬ë ¤ë³¼ê¹Œìš”?";

        showLocalNotification(title, body);
        if (typeof window.sendPushViaWorker === "function") {
          window.sendPushViaWorker(title, body);
        }

        // í•„ìš”í•˜ë©´ í•˜ë£¨ 1íšŒ ì œí•œìš© ë¡œì§ë„ ì—¬ê¸°ì„œ ê°™ì´ ì²˜ë¦¬ ê°€ëŠ¥
      }
    }

    function checkScheduledNotifications() {
      const now = new Date();
      checkDdayNotifications(now);
      checkStudyStartReminder(now);
    }

    // 1ì´ˆë§ˆë‹¤ ì•Œë¦¼ ì¡°ê±´ ì²´í¬ (ë¶€í•˜ ê±°ì˜ ì—†ìŒ)
    setInterval(checkScheduledNotifications, 1000);

    // ===== To-do ìŠ¤íƒ€ì¼ ë¼ë””ì˜¤ ì ìš© =====
    const todoStyleRadios = document.querySelectorAll('input[name="todo-style"]');
    if (todoStyleRadios.length) {
      todoStyleRadios.forEach((radio) => {
        radio.checked = radio.value === todoStyle;
        radio.addEventListener("change", () => {
          if (!radio.checked) return;
          todoStyle = radio.value;
          localStorage.setItem(TODO_STYLE_KEY, todoStyle);
          renderTodoList();
          renderCalendarSelectedTasks(selectedCalendarDateStr);
        });
      });
    }

    // ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/My-Study-OS/service-worker.js")
          .then((reg) => {
            console.log("[SW] ë“±ë¡ ì„±ê³µ", reg);
            // FCMì—ì„œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ì— ì €ì¥
            window.myStudyOsSwReg = reg;
          })
          .catch((err) => console.error("SW ë“±ë¡ ì‹¤íŒ¨:", err));
      });
    }

  </script>

  <!-- Firebase & ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import {
      getMessaging,
      getToken,
      onMessage
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-messaging.js";

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyC-OtOZzkLk1f70wWegmv2zDcCJqlFZlLA",
      authDomain: "my-study-os-3758c.firebaseapp.com",
      projectId: "my-study-os-3758c",
      storageBucket: "my-study-os-3758c.firebasestorage.app",
      messagingSenderId: "632448831360",
      appId: "1:632448831360:web:bd8f776773cdfc72f93b65",
      measurementId: "G-VD3P1XY2E7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const messaging = getMessaging(app);
    const provider = new GoogleAuthProvider();

    // â˜… í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ FCM í† í°ì„ ì €ì¥í•´ ë‘˜ ë³€ìˆ˜
    let currentFcmToken = null;

    // FCM í† í° ìƒì„± + Firestore ì €ì¥
    async function initFcmForUser(user) {
      try {
        // 1) ë¸Œë¼ìš°ì € ì§€ì› ì²´í¬
        if (!("Notification" in window) || !("serviceWorker" in navigator)) {
          console.log("[FCM] ì´ ë¸Œë¼ìš°ì €ëŠ” Notification ë˜ëŠ” ServiceWorker ë¯¸ì§€ì›");
          return;
        }

        // 2) ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        let permission = Notification.permission;
        if (permission !== "granted") {
          permission = await Notification.requestPermission();
        }
        if (permission !== "granted") {
          console.log("[FCM] ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•ŠìŒ");
          return;
        }

        // 3) ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ (ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´ ì¬ì‚¬ìš©ë¨)
        const swReg = await navigator.serviceWorker.register("/My-Study-OS/service-worker.js");
        console.log("[FCM] ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡/íšë“:", swReg);

        // 4) VAPID ê³µê°œí‚¤ + ì„œë¹„ìŠ¤ì›Œì»¤ë¥¼ ì‚¬ìš©í•´ì„œ í† í° ë°œê¸‰
        const token = await getToken(messaging, {
          vapidKey: "BLmff8N-OMJB0gIgnpx1fKNZafhpgE0lxPkDaML82X0xBTEYjgDV-2C8bfSTnhL3dppbqOq4Xmol6INZSVkyE4U",
          serviceWorkerRegistration: swReg
        });

        if (!token) {
          console.log("[FCM] í† í°ì„ ê°€ì ¸ì˜¤ì§€ ëª»í•¨");
          return;
        }

        console.log("[FCM] ë¸Œë¼ìš°ì € í† í°:", token);
        currentFcmToken = token;   // â˜… ì¶”ê°€: ì „ì—­ ë³€ìˆ˜ì— í† í° ì €ì¥

        // 5) ë¡œì»¬ì—ë„ ì €ì¥ (ì„ íƒ)
        try {
          localStorage.setItem("study_os_fcm_token", token);
        } catch (e) {
          console.warn("[FCM] ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨", e);
        }

        // 6) Firestore: users/{uid}/devices/{token}
        const deviceRef = doc(db, "users", user.uid, "devices", token);
        await setDoc(
          deviceRef,
          {
            token,
            platform: navigator.userAgent,
            updatedAt: Date.now()
          },
          { merge: true }
        );
      } catch (err) {
        console.error("[FCM] initFcmForUser ì˜¤ë¥˜", err);
      }
    }

    // === Cloudflare Workerë¥¼ í†µí•´ í‘¸ì‹œ ë³´ë‚´ëŠ” í•¨ìˆ˜ ===
    async function sendPushViaWorker(title, body) {
      if (!currentFcmToken) {
        console.warn("[Push] FCM í† í°ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      try {
        const res = await fetch("https://my-study-os-push.ganghealthy.workers.dev/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token: currentFcmToken,
            title: title || "My Study OS",
            body: body || "í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸",
          }),
        });

        const data = await res.json();
        console.log("[Push] Worker ì‘ë‹µ:", data);
      } catch (err) {
        console.error("[Push] Worker í˜¸ì¶œ ì˜¤ë¥˜:", err);
      }
    }

    // ì½˜ì†”ì—ì„œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆê²Œ ì „ì—­ìœ¼ë¡œ êº¼ë‚´ë‘ê¸°
    window.sendPushViaWorker = sendPushViaWorker;

    // ì•±ì´ ì¼œì ¸ ìˆì„ ë•Œ ì˜¤ëŠ” í‘¸ì‹œ(í¬ê·¸ë¼ìš´ë“œ) ì²˜ë¦¬
    onMessage(messaging, (payload) => {
      console.log("[FCM] í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€:", payload);
      const title = payload.notification?.title || "My Study OS";
      const body = payload.notification?.body || "";

      if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, {
          body,
          icon: "/My-Study-OS/icon-192.png"
        });
      }
    });

    const loginBtn   = document.getElementById("google-login-btn");
    const logoutBtn  = document.getElementById("google-logout-btn");
    const statusEl   = document.getElementById("google-status");
    const backupBtn  = document.getElementById("cloud-backup-btn");
    const restoreBtn = document.getElementById("cloud-restore-btn");

    const LOCAL_KEYS = [
      "study_os_ddays_v1",
      "study_os_dday",          // êµ¬ë²„ì „ ë‹¨ì¼ D-Day
      "study_os_goals",
      "study_os_todos_v1",
      "study_os_pomo_config_v1",
      "study_os_study_log_v1",
      "study_os_current_session",
      "study_os_theme",
      "study_os_timetable_v1",
      "study_os_todo_style"
    ];

    function getLocalData() {
      const data = {};
      LOCAL_KEYS.forEach(key => {
        const val = localStorage.getItem(key);
        if (val !== null) data[key] = val;
      });
      return data;
    }

    async function saveCloud(user) {
      const data = getLocalData();
      const ref = doc(db, "users", user.uid);
      await setDoc(ref, data, { merge: true });
      alert("í´ë¼ìš°ë“œ ë°±ì—… ì™„ë£Œ!");
    }

    async function loadCloud(user) {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        alert("í´ë¼ìš°ë“œì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const data = snap.data();
      Object.keys(data).forEach(key => localStorage.setItem(key, data[key]));
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
      location.reload();
    }

    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        alert("ë¡œê·¸ì¸ ì˜¤ë¥˜ ë°œìƒ");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    backupBtn.addEventListener("click", () => {
      const user = auth.currentUser;
      if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
      saveCloud(user);
    });

    restoreBtn.addEventListener("click", () => {
      const user = auth.currentUser;
      if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
      if (!confirm("í´ë¼ìš°ë“œ ë°ì´í„°ë¥¼ í˜„ì¬ ê¸°ê¸° ë°ì´í„°ì— ë®ì–´ì”ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) return;
      loadCloud(user);
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        statusEl.textContent = `ë¡œê·¸ì¸ë¨: ${user.displayName || user.email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-flex";
        backupBtn.disabled = false;
        restoreBtn.disabled = false;

        // âœ… ë¡œê·¸ì¸ëœ ìœ ì €ì— ëŒ€í•´ FCM í† í° ë“±ë¡
        await initFcmForUser(user);
      } else {
        statusEl.textContent = "ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.";
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        backupBtn.disabled = true;
        restoreBtn.disabled = true;
      }
    });

    // ===== í¬ê·¸ë¼ìš´ë“œ FCM ë©”ì‹œì§€ ì²˜ë¦¬ =====
    onMessage(messaging, (payload) => {
      console.log("[FCM] í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ :", payload);

      const title =
        (payload.notification && payload.notification.title) ||
        "My Study OS";
      const body =
        (payload.notification && payload.notification.body) ||
        "";

      // ì´ë¯¸ ì•ì—ì„œ ë§Œë“  ë¡œì»¬ ì•Œë¦¼ í•¨ìˆ˜ë¥¼ ì¬ì‚¬ìš©
      if (typeof showLocalNotification === "function") {
        showLocalNotification(title, body);
      } else if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, {
          body,
          icon: "/My-Study-OS/icon-192.png"
        });
      }
    });

    logoutBtn.style.display = "none";
    backupBtn.disabled = true;
    restoreBtn.disabled = true;
  </script>

  <!-- ê°•ì œ ìƒˆë²„ì „ ë¡œë“œ -->
  <script>
    document.getElementById("hard-reload-btn")?.addEventListener("click", async () => {
      const confirmReload = confirm(
        "ìºì‹œì™€ ì„œë¹„ìŠ¤ì›Œì»¤ë¥¼ ì‚­ì œí•˜ê³  ìµœì‹  ë²„ì „ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?\n(ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)"
      );
      if (!confirmReload) return;

      try {
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const reg of registrations) {
            await reg.unregister();
          }
        }

        if ('caches' in window) {
          const keys = await caches.keys();
          for (const key of keys) {
            await caches.delete(key);
          }
        }

        alert("ìƒˆ ë²„ì „ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤!");
        window.location.reload(true);

      } catch (e) {
        console.error(e);
        alert("ê°•ì œ ìƒˆë²„ì „ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });

    document.getElementById("reset-all-btn")?.addEventListener("click", () => {
      if (!confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
      localStorage.clear();
      alert("ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
      window.location.reload();
    });
  </script>
</body>
</html>
